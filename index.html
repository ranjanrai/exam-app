<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- Firebase compat SDKs -->
<!-- Firebase SDKs (compat versions for your existing code) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<title>Offline MCQ Exam ‚Äî Full App (Firestore)</title>
<style>
/* (kept your CSS exactly as before ‚Äî shortened here in the preview for brevity) */
#fsQuestion div {
  margin: 0;     /* remove default div margins */
  padding: 0;    /* no extra space */
}
.admin-question-text {
  white-space: pre-wrap;   /* preserve newlines & spaces */
  word-wrap: break-word;   /* wrap long words */
  margin-top: 4px;
  display: block;
}
.admin-question-text {
  white-space: pre-wrap;
  word-wrap: break-word;
}
#fsQuestion {
   max-height: 40vh;  /* reduce box height */
  overflow-y: auto;
  padding: 2px 6px;    /* less inner space */
  margin-bottom: 8px;  /* less gap below */
  border-radius: 6px;
  background: transparent;
  color: #e6eef8;
  white-space: pre-wrap;
}
.exam-message {
position: fixed;     /* stick to top */
  top: 0;
  left: 0;
  width: 100%;
  overflow: hidden;
  background: #002b5c;
  color: #fff;
  padding: 8px 0;
  font-weight: bold;
  text-align: center;
  border-radius: 0 0 6px 6px;
  margin-bottom: 10px;
}

#examMsg {
  display: inline-block;
  font-size: 16px;
  animation: colorChange 3s infinite alternate;
}

@keyframes colorChange {
  0%   { color: #ffeb3b; }  /* yellow */
  25%  { color: #4caf50; }  /* green */
  50%  { color: #03a9f4; }  /* blue */
  75%  { color: #e91e63; }  /* pink */
  100% { color: #ff5722; }  /* orange */
}
#examInner {
  margin-top: 40px;
}
 :root{
    --bg:#071428; --panel:#0b1a2b; --muted:#9aa6b2; --text:#e6eef8;
    --brand:#60a5fa; --good:#34d399; --danger:#f87171;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:linear-gradient(180deg,#061026,#071428)}
  .wrap{max-width:1100px;margin:20px auto;padding:18px}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{font-weight:800;font-size:20px}
  .hint{color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .row{display:flex;gap:10px;align-items:center}
  .spacer{flex:1}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type="text"], input[type="password"], input[type="number"], textarea, select { width:100%; padding:8px; border-radius:8px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); }
  textarea{
min-height:80px
 resize: vertical;
  padding: 8px;
  line-height: 1.4;
  vertical-align: top;
  text-align: left;}
  .btn{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn.brand{background:var(--brand);color:#042033}
  .btn.warn{background:var(--good);color:#042033}
  .btn.danger{background:var(--danger);color:white}
  .small{font-size:12px;color:var(--muted)}
  .hidden{display:none!important}
  .list { max-height:320px; overflow:auto; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); padding:8px }
  .list-item{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; gap:8px; align-items:center; }
  .badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02); color:var(--muted); font-weight:700; font-size:12px}
  /* Fullscreen exam */
  #examFullscreen{position:fixed;inset:0;background:linear-gradient(180deg,#041022,#041b2a);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
  #examInner{width:min(1100px,96%);background:linear-gradient(180deg,#061426,#07182a);border-radius:14px;padding:22px;display:flex;gap:20px;align-items:flex-start;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
  #fsUser{flex:0 0 220px;text-align:center}
  #fsUser img{width:160px;height:160px;border-radius:50%;object-fit:cover;border:4px solid rgba(255,255,255,0.04)}
  #fsUser h2{margin:12px 0 6px;font-size:20px}
  #fsMain {
  flex: 1;
  min-width: 320px;
  display: flex;
  flex-direction: column;
  max-height: 70vh; /* limit height on small screens */
}
#fsQuestion, #fsOptions {
  flex-shrink: 0;
}
#fsScrollArea {
  flex: 1;
  overflow-y: auto;   /* only this part scrolls */
  margin-bottom: 8px;
}
  .fsQuestion{font-size:20px;font-weight:700;margin-bottom:14px}
  .fsOptions{display:grid;gap:10px}
  .fsOpt{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:flex;gap:10px;align-items:center}
  .fsOpt.selected{outline:3px solid white;background:linear-gradient(90deg,rgba(96,165,250,0.04),transparent)}

.fsFooter {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #07182a;
  position: sticky;
  bottom: 0;
  z-index: 20;
}

  .timer{font-weight:900;font-variant-numeric:tabular-nums}
  .progress-bar{width:100%;background:rgba(255,255,255,0.03);height:18px;border-radius:999px;margin-top:12px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#34d399,#60a5fa);width:0%;transition:width 800ms ease}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{background:rgba(255,255,255,0.02)}
  /* responsive */
  @media (max-width:900px){
    #examInner{flex-direction:column;align-items:center}
    #fsUser{order:1}
    #fsMain{order:2;width:100%}
  }
.userPhoto {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
}
  #examCharacter {
  position: fixed;
  top: 50px;
  left: 50px;
  width: 60px;       /* size of your character */
  height: 60px;
  pointer-events: none; /* so it won‚Äôt block clicks */
  transition: transform 0.1s linear; /* smooth movement */
  z-index: 9999;
}
.answer-stats {
  margin-top: 6px;
  font-size: 14px;
  color: var(--muted);
  text-align: center;
}
.answer-stats span {
  margin: 0 8px;
}

@media (max-width:600px){
  body { font-size:14px; }
  .brand { font-size: 16px; }
  h3 { font-size: 16px; }
  .btn { padding: 6px 10px; font-size: 14px; }
}
@media (max-width:600px){
  .btn { width: 100%; margin-bottom: 6px; }
  .row { flex-direction: column; align-items: stretch; }
}
@media (max-width:600px){
  #fsUser img { width: 100px; height: 100px; }
}
/* Compact grid of question numbers on mobile */
@media (max-width:600px){
  #questionNav {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
    gap: 6px;
    padding: 8px 4px;
  }
  #questionNav button {
    min-width: 40px;
    height: 40px;
    font-size: 14px;
    text-align: center;
    border-radius: 6px; /* square with rounded edges */
    padding: 0;
  }
}
</style>
</head>
<body>
<div class="wrap card">
  <div class="header">
    <div>
      <div class="brand">Offline MCQ Examination<br>Made by Ranjan Kumar <br> Regional College of Pharmaceutical Sciences<br>Subject : COMPUTER APPLICATIONS IN PHARMACY (Practical)<br>SUBJECT CODE-BP210P<br>Total Marks-20 Marks</div>
      <div class="hint">Online ‚Ä¢ Firestore ‚Ä¢ Firebase Storage ‚Ä¢ Admin results</div>
    </div>
    <div class="row">
      <button class="btn brand" onclick="showSection('user')">User</button>
      <button class="btn" onclick="showSection('import')">Import/Export</button>
      <button class="btn" onclick="showSection('adminLogin')">Admin Login</button>
    </div>
  </div>

  <!-- USER SECTION -->
  <section id="user">
<div id="statusBox" style="padding:6px;font-weight:bold;color:white;background:#333;">
  Checking connection...
</div>
    <div class="card">
      <h3>User Login / Register</h3>
      <div class="row" style="gap:12px">
        <div style="flex:1">
          <label>Username</label>
          <input id="userName" class="input" type="text" placeholder="username (e.g. rahul)">
        </div>
        <div style="width:220px">
          <label>Photo (first-time)</label>
          <input id="userPhoto" type="file" accept="image/*">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Password</label>
          <input id="userPass" type="password">
        </div>
        <div style="width:160px;align-self:end">
          <button class="btn brand" onclick="handleUserLogin()">Login / Register</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">If username exists, enter the same password to login. New users must upload photo to register.</div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <h3>Quick Import / Export</h3>
      <div class="row">
        <button class="btn" onclick="triggerImportUsers()">Import Users (.json)</button>
        <button class="btn" onclick="triggerImportQuestions()">Import Questions (.json)</button>
        <div class="spacer"></div>
        <button class="btn" onclick="exportUsers()">Export Users (.json)</button>
        <button class="btn" onclick="exportQuestions()">Export Questions (.json)</button>
      </div>
      <div class="small" style="margin-top:8px">App auto-loads previously stored users & questions on page load (from Firestore).</div>
    </div>
  </section>

  <!-- IMPORT / EXPORT -->
  <section id="import" class="hidden">
    <div class="card">
      <h3>Import / Export</h3>
      <div class="row">
        <div style="flex:1">
          <label>Import Users (JSON file with array of {username,password,photo})</label>
          <input id="impUsersFile" type="file" accept="application/json" onchange="importUsersFile(event)">
        </div>
        <div style="width:220px">
          <label>Import Questions (.json)</label>
          <input id="impQFile" type="file" accept="application/json" onchange="importQuestionsFile(event)">
        </div>
      </div>
<div style="height:12px"></div>
<div class="row">
  <button class="btn" onclick="exportSettings()">Export Exam Settings (.json)</button>
  <button class="btn" onclick="triggerImportSettings()">Import Exam Settings (.json)</button>
  <input id="impSettingsFile" type="file" accept="application/json" onchange="importSettingsFile(event)" style="display:none">
</div>

      <div style="height:12px"></div>
    <div class="row">
  <button class="btn" onclick="exportUsers()">Export Users (.json)</button>
  <button class="btn" onclick="exportQuestions()">Export Questions (.json)</button>
  <div class="spacer"></div>
  <button class="btn warn" onclick="downloadFullBackup()">Download Full Backup (.json)</button>
</div>


<div class="row" style="margin-top:10px">
  <label class="btn">
    Import Full Backup (.json)
    <input type="file" id="importBackupFile" accept="application/json"
           style="display:none"
           onchange="importFullBackup(this.files[0])">
  </label>
</div>

<div class="small" style="margin-top:8px">
  Photos should be base64 or URLs in the users JSON to be compatible with import.
</div>
</section>

  <!-- ADMIN LOGIN -->
  <section id="adminLogin" class="hidden">
    <div class="card">
      <h3>Admin Login</h3>
      <label>Admin password</label>
      <input id="adminPass" type="password" value="">
      <div class="row" style="margin-top:10px">
        <button class="btn brand" onclick="handleAdminLogin()">Login</button>
        <div class="spacer"></div>
        <div class="small">Made by: <b>Ranjan Kumar</b></div>
      </div>
    </div>
  </section>

  <!-- ADMIN PANEL (visible after login) -->
<section id="adminPanel" class="hidden">

  <!-- Exam Settings Card -->
<h2>Exam Settings</h2>

<label>Exam Title</label>
<input id="adminExamTitle" placeholder="Exam Title">

<label>Duration (mins)</label>
<input id="adminDuration" type="number" placeholder="Duration">

<label>Max Marks</label>
<input id="adminMaxMarks" type="number" placeholder="Max Marks">

<label>Synopsis Count</label>
<input id="adminCountSynopsis" type="number" placeholder="Synopsis">

<label>Minor Count</label>
<input id="adminCountMinor" type="number" placeholder="Minor">

<label>Major Count</label>
<input id="adminCountMajor" type="number" placeholder="Major">

<label>Viva Count</label>
<input id="adminCountViva" type="number" placeholder="Viva">

<!-- üîπ Save button should go here -->
<button onclick="saveSettings()">Save Settings</button>

<label style="margin-top:8px">Synopsis Questions</label>
<input id="adminCountSynopsis" type="number" min="0" value="2" oninput="updateQuestionPreview()"/>

<label style="margin-top:8px">Minor Practical Questions</label>
<input id="adminCountMinor" type="number" min="0" value="2" oninput="updateQuestionPreview()"/>

<label style="margin-top:8px">Major Practical Questions</label>
<input id="adminCountMajor" type="number" min="0" value="1" oninput="updateQuestionPreview()"/>

<label style="margin-top:8px">Viva Questions</label>
<input id="adminCountViva" type="number" min="0" value="2" oninput="updateQuestionPreview()"/>


<div id="questionPreview" class="small" style="margin-top:8px; font-weight:bold; color:#2563eb;">
  Total Questions: 0
</div>

  <div class="card">
    <h3>Exam Settings</h3>
    <label>Exam Duration (minutes)</label>
<label style="margin-top:8px">Number of Questions</label>
<label style="margin-top:8px">
  <input type="checkbox" id="adminShuffle"> Shuffle Questions
</label>
<input id="adminTotalQs" type="number" min="1" value="10"/>
    <input id="adminDuration" type="number" min="1" value="30"/>
<label style="margin-top:8px">Custom Exam Message</label>
  <input id="adminCustomMsg" type="text" value="üì¢ Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar üöÄ"/>
    <div class="row" style="margin-top:8px">
      <button class="btn brand" onclick="saveExamSettings()">Save Settings</button>
    </div>
    <div class="small">This duration will apply to all new exams.</div>
  </div>

  <div style="height:12px"></div>

  <!-- Question Bank Card -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div style="flex:1">
        <h3>Question Bank ‚Äî Add / Edit</h3>
        <label>Category</label>
        <select id="qCategory">
          <option>Synopsis</option>
          <option>Minor Practical</option>
          <option>Major Practical</option>
          <option>Viva</option>
        </select>
        <label style="margin-top:8px">Question</label>
        <textarea id="qText"></textarea>
        <label>Option A</label><input id="qA" type="text"/>
        <label>Option B</label><input id="qB" type="text"/>
        <label>Option C</label><input id="qC" type="text"/>
        <label>Option D</label><input id="qD" type="text"/>
        <div class="row" style="margin-top:8px;align-items:center">
          <div style="width:160px">
            <label>Correct answer</label>
            <select id="qAnswer">
              <option value="0">A</option>
              <option value="1">B</option>
              <option value="2">C</option>
              <option value="3">D</option>
            </select>
          </div>
          <div style="width:120px">
            <label>Marks</label>
            <input id="qMarks" type="number" min="1" value="1"/>
          </div>
          <div class="spacer"></div>
          <button class="btn brand" onclick="saveQuestion()">Save</button>
          <button class="btn danger" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>

      <div style="width:420px;min-width:280px">
        <h3>Questions</h3>
        <div id="questionsList" class="list"></div>
        <div style="margin-top:8px" class="row">
          <button class="btn" onclick="exportQuestions()">Export questions (.json)</button>
          <button class="btn danger" onclick="clearAllQuestions()">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- Users Card -->
  <div class="card">
    <h3>Users</h3>
    <div class="row">
      <div style="flex:1">
        <label>Username</label><input id="adminNewUser" type="text"/>
<label>Full Name</label><input id="adminNewFull" type="text"/>
        <label>Password</label><input id="adminNewPass" type="text"/>
        <label>Photo</label><input id="adminNewPhoto" type="file" accept="image/*"/>
        <div class="row" style="margin-top:8px">
          <button class="btn brand" onclick="adminCreateUser()">Create / Update</button>
          <button class="btn danger" onclick="adminClearUsers()">Delete All Users</button>
        </div>
      </div>
      <div style="width:360px">
        <h4>Existing Users</h4>
        <div id="adminUsersList" class="list"></div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- Results Card -->
  <div class="card">
    <h3>Results</h3>
    <div class="row">
      <button class="btn" onclick="renderResults()">Refresh</button>
      <button class="btn" onclick="exportResultsJSON()">Export results (.json)</button>
      <button class="btn" onclick="triggerImportResults()">Import results (.json)</button>
      <button class="btn" onclick="exportResultsCSV()">Export results (.csv)</button>
      <div class="spacer"></div>
      <button class="btn danger" onclick="clearResults()">Clear Results</button>
    </div>
    <input id="impResultsFile" type="file" accept="application/json" multiple onchange="importResultsFile(event)" style="display:none">
    <div id="resultsArea" style="margin-top:10px; max-height:360px; overflow:auto"></div>
  </div>

</section>


  <div style="height:12px"></div>
  <div class="small">Tip: All data stored online in Firebase. Use export/import to create portable backups.</div>
</div>

<!-- Fullscreen exam -->
<div id="examFullscreen">
<!-- Instructions Overlay -->
<div id="examInstructionsOverlay" 
     style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; 
            background:rgba(0,0,0,0.9); z-index:10000;">
  <div style="max-width:700px; background:#0b1a2b; padding:20px; border-radius:12px; 
              color:#e6eef8; text-align:left; box-shadow:0 0 25px rgba(0,0,0,0.6)">
    <h2 style="text-align:center; color:#60a5fa;">üìò Exam Instructions</h2>
    <ul style="margin-top:12px; line-height:1.6;">
      <li>‚úÖ Stay in fullscreen mode during the exam. Exiting will pause the test.</li>
      <li>‚úÖ Do not refresh or close the browser during the exam.</li>
      <li>‚úÖ Use the navigation buttons to move between questions.</li>
      <li>‚úÖ You may flag questions for review before submission.</li>
      <li>‚úÖ Timer will count down automatically. Submit before time runs out.</li>
      <li>‚úÖ Results will be shown immediately after submission.</li>
    </ul>
    <div style="text-align:center; margin-top:20px;">
      <button onclick="dismissInstructions()" 
              style="padding:10px 20px; font-size:16px; font-weight:bold; 
                     border-radius:10px; background:#34d399; color:#042033; cursor:pointer;">
        üöÄ Start Exam
      </button>
    </div>
  </div>
</div>

  <!-- üîπ Custom Animated Message (top banner) -->
  <div class="exam-message">
     <div id="examMsg">üì¢ Welcome to your exam! Best of luck üöÄ </div>
  </div>
<div id="examCharacterName" 
     style="
       position: absolute;
       font-size: 24px;
       font-weight: bold;
       color: #60a5fa;
       pointer-events: none;
       user-select: none;
       z-index: 9999;
     ">
</div>
<!-- üîí Lock screen when exam is paused -->
<div id="lockScreen"
     style="position:fixed;inset:0;background:rgba(0,0,0,0.85);
            color:white;display:none;flex-direction:column;align-items:center;
            justify-content:center;z-index:10000;">
  <h2>‚ö†Ô∏è Exam Paused</h2>
  <p>You exited fullscreen mode. Enter the password to continue.</p>
  <input type="password" id="unlockPassword" placeholder="Enter password"
         style="padding:8px;margin-top:10px">
  <button onclick="unlockExam()" 
          style="padding:8px 15px;margin-top:10px;cursor:pointer;">
    Unlock & Resume
  </button>
</div>

  <div id="examInner">
    <div id="fsUser">
      <img id="fsPhoto" src="" alt="photo">
      <h2 id="fsName"></h2>
      <div class="small" id="fsMeta"></div>
 <div id="answerStats" class="answer-stats"></div>
    </div>
    <div id="fsMain">
      <div id="fsScrollArea">
  <div id="fsQuestion">Question will appear here</div>
  <div id="fsOptions"></div>
</div>

      <!-- NEW: Direct question navigation -->
      <div id="questionNav" style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0;"></div>

      <div class="fsFooter">
        <div style="display:flex;gap:8px;">
          <button class="btn" onclick="toggleFlag()">‚öë Flag</button>
          <button class="btn" onclick="prevQuestion()">‚üµ Prev</button>
          <button class="btn" onclick="nextQuestion()">Next ‚ü∂</button>
        </div>
        <div class="spacer"></div>
        <div class="timer" id="fsTimer">00:00:00</div>
        <button class="btn warn" onclick="submitExam()">Submit</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="fsProgressFill"></div></div>
    </div>
  </div>
<div id="answerStats" class="answer-stats"></div>

</div>

<script>
// ---------- Firebase config & init ----------
const firebaseConfig = {
  apiKey: "AIzaSyC7X0B65qfWiSkSaC_-dXElw687ZmVM9gU",
  authDomain: "exam-system-2ed90.firebaseapp.com",
  projectId: "exam-system-2ed90",
  storageBucket: "exam-system-2ed90.firebasestorage.app",
  messagingSenderId: "576581410555",
  appId: "1:576581410555:web:e38cea3f14d10e5daa5a5e",
  measurementId: "G-BCFKVMVTBE"
};


 // Initialize Firebase
  firebase.initializeApp(firebaseConfig);


  // Firestore + Storage references
  const db = firebase.firestore();
const storage = firebase.storage();

// ---------- Helpers ----------
const $ = s => document.querySelector(s);
const $all = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);
const escapeHTML = str => String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

// ---------- Global state ----------
let users = [];        // array of user objects
let questions = [];    // array of question objects
let results = [];      // array of result objects
let adminCred = { username: 'admin', password: 'admin123' };
let settings = {
  durationMin: 30,
  customMsg: "üì¢ Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar üöÄ",
  shuffle: false,
  counts: { Synopsis: 2, "Minor Practical": 2, "Major Practical": 1, Viva: 2 }
};

// UI helpers: show sections
function showSection(id){
  ['user','import','adminLogin','adminPanel'].forEach(s => { const el = document.getElementById(s); if(!el) return; el.classList.add('hidden'); });
  document.getElementById(id).classList.remove('hidden');
  if(id === 'adminPanel') {
    renderQuestionsList();
    renderUsersAdmin();
    renderResults();
  }
}

/* ---------- Firestore CRUD wrappers ---------- */

// Users
async function saveUserToFirestore(userObj) {
  await db.collection('users').doc(userObj.username).set(userObj);
}
async function loadUsersFromFirestore() {
  const snap = await db.collection('users').get();
  const arr = [];
  snap.forEach(doc => arr.push(doc.data()));
  return arr;
}

// Questions
async function saveQuestionToFirestore(q) {
  await db.collection('questions').doc(String(q.id)).set(q);
}
async function loadQuestionsFromFirestore() {
  const snap = await db.collection('questions').get();
  const arr = [];
  snap.forEach(doc => arr.push(doc.data()));
  return arr;
}
async function deleteAllQuestionsFirestore() {
  const snap = await db.collection('questions').get();
  const batch = db.batch();
  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}

// Results
async function saveResultToFirestore(record) {
  // record should be an object with username, totalScorePercent, sectionScores, timestamp
  await db.collection('results').add(record);
}
async function loadResultsFromFirestore() {
  const snap = await db.collection('results').orderBy('timestamp','desc').get();
  const arr = [];
  snap.forEach(doc => arr.push(doc.data()));
  return arr;
}
async function clearResultsFirestore() {
  // Deletes all docs in results (use with caution)
  const snap = await db.collection('results').get();
  const batch = db.batch();
  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
}

// Settings
async function saveSettingsToFirestore(s) {
  await db.collection('settings').doc('exam').set(s);
}
async function loadSettingsFromFirestore() {
  const doc = await db.collection('settings').doc('exam').get();
  return doc.exists ? doc.data() : null;
}

/* ---------- Startup: check Firestore & load data ---------- */
async function initApp() {
  try {
    // try a simple Firestore request to check connectivity
    await db.collection('users').limit(1).get();
    document.getElementById("statusBox").innerText = "üü¢ Online (Firestore)";
    document.getElementById("statusBox").style.background = "#2e7d32";
  } catch (err) {
    console.error("Firestore unreachable", err);
    document.getElementById("statusBox").innerText = "üî¥ Firestore not reachable";
    document.getElementById("statusBox").style.background = "#b71c1c";
    alert("‚ö†Ô∏è Firestore not reachable from this browser. The app requires an online connection to work correctly.");
    return;
  }

  // Load settings (if any)
  const s = await loadSettingsFromFirestore();
  if(s) settings = s;

  // Load questions
  questions = await loadQuestionsFromFirestore();
  if(!questions || questions.length === 0){
    // seed sample questions into Firestore
    const seed = [
      { id: uid(), question: 'HTML stands for?', options: ['Hyperlinks Text Markup','Home Tool Markup','Hyper Text Markup Language','Hyperlinking Text Markdown'], answer: 2, marks: 1, category: 'Synopsis' },
      { id: uid(), question: 'Which tag defines paragraph?', options: ['<p>','<para>','<pg>','<par>'], answer: 0, marks: 1, category: 'Minor Practical' },
      { id: uid(), question: 'Which method adds to array end?', options: ['push','pop','shift','unshift'], answer: 0, marks: 2, category: 'Major Practical' },
      { id: uid(), question: 'Does localStorage persist after browser restart?', options: ['Yes','No','Sometimes','Depends'], answer: 0, marks: 1, category: 'Viva' }
    ];
    for(const q of seed) await saveQuestionToFirestore(q);
    questions = await loadQuestionsFromFirestore();
  }

  // Load users
  users = await loadUsersFromFirestore();

  // Load results
  results = await loadResultsFromFirestore();

  renderQuestionsList();
  renderUsersAdmin();
  renderResults();
  renderSettingsAdmin();
  showSection('user');
}

document.addEventListener('DOMContentLoaded', initApp);
async function saveSettings() {
  // Read values from inputs
  const examTitle     = document.getElementById('adminExamTitle').value;
  const duration      = parseInt(document.getElementById('adminDuration').value) || 0;
  const maxMarks      = parseInt(document.getElementById('adminMaxMarks').value) || 0;
  const countSynopsis = parseInt(document.getElementById('adminCountSynopsis').value) || 0;
  const countMinor    = parseInt(document.getElementById('adminCountMinor').value) || 0;
  const countMajor    = parseInt(document.getElementById('adminCountMajor').value) || 0;
  const countViva     = parseInt(document.getElementById('adminCountViva').value) || 0;

  // Save to Firestore in "settings/default"
  await setDoc(doc(db, "settings", "default"), {
    examTitle,
    duration,
    maxMarks,
    countSynopsis,
    countMinor,
    countMajor,
    countViva
  });

  alert("Settings saved successfully ‚úÖ");
}


/* ---------- User flow (register/login) ---------- */

// Convert file -> upload to Storage and return URL
async function uploadPhoto(file, username) {
  try {
    const path = `photos/${username}_${Date.now()}_${file.name}`;
    const ref = firebase.storage().ref().child(path);
    const snapshot = await ref.put(file);
    const url = await snapshot.ref.getDownloadURL();
    return url; // return photo URL string
  } catch (err) {
    console.error("‚ùå Upload failed:", err);
    throw err;
  }
}

async function handleUserLogin(){
  const username = $('#userName').value.trim();
  const pass = $('#userPass').value;
  const fileInput = document.getElementById('userPhoto');
  const file = fileInput.files[0];

  if(!username || !pass) return alert('Enter username and password');

  // Try find user in Firestore
  const userDoc = await db.collection('users').doc(username).get();
  if(userDoc.exists){
    const user = userDoc.data();
    if(user.password !== pass) return alert('Incorrect password');
    startExam(user);
    return;
  } else {
    // register new: must provide photo
    if(!file) return alert('New user: upload photo to register');
    const photoURL = await uploadPhoto(file, username);
    const fullName = username;
    const userObj = { username, password: pass, photo: photoURL, fullName };
    await saveUserToFirestore(userObj);
    alert('‚úÖ Registered & saved online');
    startExam(userObj);
    return;
  }
}

/* ---------- Exam runtime (mostly unchanged UI logic) ---------- */

let EXAM = {
  paper: [],      // array of questions (copied)
  state: null,    // {username,answers:{qId:choice},flags:{qId:true},startedAt,remainingMs,submitted}
  timerId: null,
  cur: 0,
  cfg: { durationMin: 30, total: null, shuffle: false } // default
};

function buildPaper(qbank, shuffle){
  let selected = [];

  const byCategory = {
    Synopsis: qbank.filter(q => q.category === "Synopsis"),
    "Minor Practical": qbank.filter(q => q.category === "Minor Practical"),
    "Major Practical": qbank.filter(q => q.category === "Major Practical"),
    Viva: qbank.filter(q => q.category === "Viva")
  };

  function pickRandom(arr, count){
    const copy = arr.slice();
    const chosen = [];
    for (let i = 0; i < count && copy.length > 0; i++) {
      const idx = Math.floor(Math.random() * copy.length);
      chosen.push(copy.splice(idx,1)[0]);
    }
    return chosen;
  }

  for (let cat in settings.counts){
    if (byCategory[cat]) {
      selected = selected.concat(pickRandom(byCategory[cat], settings.counts[cat]));
    }
  }

  if (shuffle) {
    for (let i = selected.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [selected[i], selected[j]] = [selected[j], selected[i]];
    }
  }

  return selected.map(q => (Object.assign({}, q)));
}

function startExam(user){
  enterFullscreen(document.documentElement);
  EXAM.cfg.total = settings.totalQs || questions.length;
  EXAM.cfg.shuffle = settings.shuffle || false;
  EXAM.cfg.durationMin = settings.durationMin || 30;
  document.getElementById("examMsg").textContent = settings.customMsg;
  document.getElementById("examCharacterName").textContent = user.fullName || user.username;

  EXAM.paper = buildPaper(questions, EXAM.cfg.shuffle);
  EXAM.state = { username: user.username, answers: {}, flags: {}, startedAt: Date.now(), remainingMs: EXAM.cfg.durationMin * 60 * 1000, submitted: false };
  EXAM.cur = 0;

  $('#examFullscreen').style.display = 'flex';
  $('#fsPhoto').src = user.photo || '';
  $('#fsName').textContent = user.fullName || user.username;
  paintQuestion();
  startTimer();
}

function paintQuestion() {
  const q = EXAM.paper[EXAM.cur];
  if (!q) return;

  $('#fsQuestion').innerHTML = `${EXAM.cur+1}. (${q.category}) ${escapeHTML(q.question)}`;

  const opts = $('#fsOptions'); 
  opts.innerHTML = '';

  q.options.forEach((opt, i) => {
    const d = document.createElement('div');
    d.className = 'fsOpt' + (EXAM.state.answers[q.id] === i ? ' selected' : '');
    d.innerHTML = `
      <div style="width:28px;font-weight:800">${String.fromCharCode(65+i)}.</div>
      <div style="flex:1">${escapeHTML(opt)}</div>
    `;
    d.onclick = () => { 
      EXAM.state.answers[q.id] = i; 
      paintQuestion(); 
      updateProgress(); 
    };
    opts.appendChild(d);
  });

  $('#fsMeta').textContent = `Question ${EXAM.cur+1} of ${EXAM.paper.length} ‚Ä¢ Answered: ${Object.keys(EXAM.state.answers).length}`;
  if (EXAM.state.flags[q.id]) $('#fsMeta').textContent += " ‚Ä¢ ‚öë Flagged";

  updateProgress();
  renderQuestionNav();
  updateStats();
}

function prevQuestion(){ if(EXAM.cur>0){ EXAM.cur--; paintQuestion(); } }
function nextQuestion(){ if(EXAM.cur < EXAM.paper.length - 1){ EXAM.cur++; paintQuestion(); } }
function toggleFlag(){ const q = EXAM.paper[EXAM.cur]; if(!q) return; EXAM.state.flags[q.id] = !EXAM.state.flags[q.id]; paintQuestion(); }
function updateProgress(){ const answered = Object.keys(EXAM.state.answers).length; const total = EXAM.paper.length; const pct = Math.round((answered/total) * 100); $('#fsProgressFill').style.width = pct + '%'; }
function renderQuestionNav(){
  const nav = document.getElementById('questionNav');
  nav.innerHTML = '';
  EXAM.paper.forEach((q,i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = i+1;
    if(EXAM.state.answers[q.id] !== undefined) btn.style.background = '#34d399';
    if(EXAM.state.flags[q.id]) btn.style.border = '2px solid orange';
    if(i === EXAM.cur) btn.style.outline = '2px solid #60a5fa';
    btn.onclick = ()=>{ EXAM.cur = i; paintQuestion(); };
    nav.appendChild(btn);
  });
}

/* Timer */
function startTimer(){
  stopTimer();
  const end = Date.now() + EXAM.state.remainingMs;
  updateTimerText();
  EXAM.timerId = setInterval(()=> {
    EXAM.state.remainingMs = end - Date.now();
    if(EXAM.state.remainingMs <= 0){
      EXAM.state.remainingMs = 0;
      stopTimer();
      alert("Time is over! Please click Submit to finish your exam.");
    }
    updateTimerText();
  }, 500);
}
function stopTimer(){ if(EXAM.timerId){ clearInterval(EXAM.timerId); EXAM.timerId = null; } }
function updateTimerText(){ const ms = Math.max(0, EXAM.state.remainingMs); $('#fsTimer').textContent = msToTime(ms); }
function msToTime(ms){ const s = Math.floor(ms/1000); const hh = String(Math.floor(s/3600)).padStart(2,'0'); const mm = String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }

function updateStats(){
  const answered = Object.keys(EXAM.state.answers).length;
  const total = EXAM.paper.length;
  document.getElementById('answerStats').innerHTML = `Answered: <b>${answered}</b> | Total: <b>${total}</b>`;
}

/* Submit exam: calculate marks, per-section scores, save results to Firestore */
async function submitExam(auto=false){
  if(!auto && !confirm('Submit exam now?')) return;
  stopTimer();
  const paper = EXAM.paper;
  let totalMarks = 0, earned = 0;
  const sectionScores = { 'Synopsis':0, 'Minor Practical':0, 'Major Practical':0, 'Viva':0 };

  paper.forEach(q => { 
    totalMarks += (q.marks || 1); 
    const chosen = EXAM.state.answers[q.id]; 

    if(q.category === "Major Practical") {
      if(chosen === 0) { // A ‚Üí full marks
        earned += q.marks;
        sectionScores[q.category] += q.marks;
      } 
      else if(chosen === 1) { // B ‚Üí 75%
        const val = Math.round(q.marks * 0.75);
        earned += val;
        sectionScores[q.category] += val;
      }
      else if(chosen === 2) { // C ‚Üí 50%
        const val = Math.round(q.marks * 0.5);
        earned += val;
        sectionScores[q.category] += val;
      }
      else { // D ‚Üí 0
        // no marks
      }
    } else {
      if(chosen === q.answer) {   // ‚úÖ only add if correct
        earned += (q.marks || 1); 
        sectionScores[q.category] = (sectionScores[q.category] || 0) + (q.marks || 1); 
      }
    }
  });

  earned = Math.round(earned);
  Object.keys(sectionScores).forEach(k => { sectionScores[k] = Math.round(sectionScores[k]); });
  const percent = Math.round((earned / Math.max(1, totalMarks)) * 100);

  const record = { 
    username: EXAM.state.username, 
    totalScorePercent: percent, 
    sectionScores, 
    timestamp: Date.now() 
  };

  try {
    await saveResultToFirestore(record);
    // update local results array for admin view
    results.unshift(record);
  } catch(err){
    console.error("Failed to save result to Firestore", err);
    alert("‚ùå Failed to save result online.");
  }

  // show score
  $('#fsQuestion').innerHTML = `
    <div style="text-align:center;font-size:22px;font-weight:900">
      Your Score: ${percent}%
    </div>
    <div id="redirectMsg" style="text-align:center;margin-top:10px;font-size:14px;color:var(--muted)">
      Redirecting in 5s...
    </div>
  `;
  $('#fsOptions').innerHTML = `<div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>`;

  document.querySelectorAll('.fsFooter').forEach(el => el.style.display = 'flex');
  EXAM.state.submitted = true;

  let secs = 5;
  const msgEl = document.getElementById('redirectMsg');
  const countdown = setInterval(()=>{
    secs--;
    if(secs > 0){
      msgEl.textContent = `Redirecting in ${secs}s...`;
    } else {
      clearInterval(countdown);
      $('#examFullscreen').style.display = 'none';
      showSection('user');
    }
  }, 1000);
}

/* Close fullscreen and return to main page (reload to refresh admin view) */
function closeFullscreen(){ stopTimer(); $('#examFullscreen').style.display = 'none'; location.reload(); }

/* ---------- ADMIN: login, CRUD, import/export, results ---------- */

function handleAdminLogin(){
  const pass = $('#adminPass').value;
  if(pass === adminCred.password){ enterAdmin(); return; }
  alert('Invalid admin password');
}
function enterAdmin(){
  showSection('adminPanel');
  renderQuestionsList();
  renderUsersAdmin();
  renderResults();
  renderSettingsAdmin();
}

/* Questions CRUD in admin */
let editingId = null;
function clearQuestionForm(){ editingId = null; $('#qText').value=''; $('#qA').value=''; $('#qB').value=''; $('#qC').value=''; $('#qD').value=''; $('#qMarks').value=1; $('#qAnswer').value='0'; $('#qCategory').value='Synopsis'; }
function cancelEdit(){ clearQuestionForm(); }
async function saveQuestion(){
  const text = $('#qText').value.trim();
  const opts = [ $('#qA').value.trim(), $('#qB').value.trim(), $('#qC').value.trim(), $('#qD').value.trim() ];
  if(!text || opts.some(o=>!o)) return alert('Fill question and all 4 options');
  const q = {
    id: editingId || uid(),
    question: text,
    options: opts,
    answer: parseInt($('#qAnswer').value) || 0,
    marks: parseInt($('#qMarks').value) || 1,
    category: $('#qCategory').value
  };

  try {
    await saveQuestionToFirestore(q);
    questions = await loadQuestionsFromFirestore();
    clearQuestionForm();
    renderQuestionsList();
    alert('‚úÖ Question saved online');
  } catch(err){
    console.error(err);
    alert('‚ùå Failed to save question online');
  }
}
function renderQuestionsList() {
  const out = $('#questionsList'); 
  out.innerHTML = '';
  if (questions.length === 0) { 
    out.innerHTML = '<div class="small">No questions yet.</div>'; 
    return; 
  }

  questions.forEach((q, i) => {
    const wrapper = document.createElement('div'); 
    wrapper.className = 'list-item';

    const textDiv = document.createElement('div');
    textDiv.style.flex = '1';

    textDiv.innerHTML = `
      <b>${i+1}. [${q.category}]</b>
      <div class="admin-question-text">${escapeHTML(q.question)}</div>
      <div class="small">A) ${escapeHTML(q.options[0])} 
      ‚Ä¢ B) ${escapeHTML(q.options[1])} 
      ‚Ä¢ C) ${escapeHTML(q.options[2])} 
      ‚Ä¢ D) ${escapeHTML(q.options[3])}</div>
      <div class="small">Marks: ${q.marks}</div>
    `;

    const editBtn = document.createElement('button'); 
    editBtn.className = 'btn'; 
    editBtn.textContent = 'Edit'; 
    editBtn.onclick = () => { loadQuestionToForm(q.id); };

    const delBtn = document.createElement('button'); 
    delBtn.className = 'btn danger'; 
    delBtn.textContent = 'Delete'; 
    delBtn.onclick = async () => { 
      if (confirm('Delete question?')) { 
        try {
          await db.collection('questions').doc(String(q.id)).delete();
          questions = await loadQuestionsFromFirestore();
          renderQuestionsList();
        } catch(err){
          console.error(err);
          alert('‚ùå Failed to delete question');
        }
      } 
    };

    wrapper.appendChild(textDiv);
    wrapper.appendChild(editBtn);
    wrapper.appendChild(delBtn);

    out.appendChild(wrapper);
  });
}

function loadQuestionToForm(id){
  const q = questions.find(x=>String(x.id)===String(id)); if(!q) return;
  editingId = q.id;
  $('#qText').value = q.question; $('#qA').value=q.options[0]; $('#qB').value=q.options[1]; $('#qC').value=q.options[2]; $('#qD').value=q.options[3];
  $('#qAnswer').value = String(q.answer); $('#qMarks').value = String(q.marks); $('#qCategory').value = q.category;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
async function clearAllQuestions(){ if(!confirm('Delete ALL questions?')) return; try { await deleteAllQuestionsFirestore(); questions = []; renderQuestionsList(); alert('‚úÖ All questions deleted'); } catch(err){ console.error(err); alert('‚ùå Failed to delete all questions'); } }

/* ---------------- USERS ADMIN ---------------- */

async function adminCreateUser() {
  const u = $('#adminNewUser').value.trim(); 
  const fName = $('#adminNewFull').value.trim();
  const p = $('#adminNewPass').value; 
  const f = $('#adminNewPhoto').files[0];

  if (!u || !p) return alert('username & password required');

  let photoURL = null;
  if (f) {
    try {
      photoURL = await uploadPhoto(f, u);
    } catch(err){
      console.error(err);
      alert('‚ùå Failed to upload photo');
      return;
    }
  }

  // Load existing user if any
  const userDoc = await db.collection('users').doc(u).get();
  let existing = userDoc.exists ? userDoc.data() : {};

  const obj = {
    username: u,
    fullname: fName || existing.fullname || "",
    password: p,
    photo: photoURL !== null ? photoURL : (existing.photo || "")
  };

  try {
    await saveUserToFirestore(obj);
    users = await loadUsersFromFirestore();
    renderUsersAdmin();
    $('#adminNewUser').value = '';
    $('#adminNewFull').value = '';
    $('#adminNewPass').value = '';
    $('#adminNewPhoto').value = '';
    alert("‚úÖ User saved successfully (online)");
  } catch(err){
    console.error(err);
    alert('‚ùå Failed to save user');
  }
}

async function adminEditUser(i) {
  const user = users[i];
  if (!user) return;

  const newFullName = prompt("Edit Full Name:", user.fullname || user.fullName || "");
  if (newFullName === null) return;
  const newPassword = prompt("Edit Password:", user.password || "");
  if (newPassword === null) return;

  user.fullname = newFullName;
  user.password = newPassword;

  try {
    await saveUserToFirestore(user);
    users = await loadUsersFromFirestore();
    renderUsersAdmin();
    alert('‚úÖ User updated');
  } catch(err){
    console.error(err);
    alert('‚ùå Failed to update user');
  }
}

async function adminDeleteUser(i) {
  if (!confirm("Delete this user?")) return;
  const user = users[i];
  if (!user) return;
  try {
    await db.collection('users').doc(user.username).delete();
    users = await loadUsersFromFirestore();
    renderUsersAdmin();
    alert('‚úÖ User deleted');
  } catch(err){
    console.error(err);
    alert('‚ùå Failed to delete user');
  }
}

async function renderUsersAdmin() {
  const box = $('#adminUsersList');
  box.innerHTML = '<div class="small">‚è≥ Loading users...</div>';
  try {
    users = await loadUsersFromFirestore();
    box.innerHTML = '';
    if (!users || users.length === 0) {
      box.innerHTML = '<div class="small">No users found.</div>';
      return;
    }
    users.forEach((u, i) => {
      const div = document.createElement('div');
      div.className = 'userRow';
      div.innerHTML = `
        <img src="${u.photo || ''}" class="userPhoto">
        <span><b>${u.fullname || u.fullName || ''}</b> (${u.username})</span>
        <button onclick="adminEditUser(${i})">Edit</button>
        <button onclick="adminDeleteUser(${i})">Delete</button>
      `;
      box.appendChild(div);
    });
  } catch(err){
    console.error(err);
    box.innerHTML = '<div class="small">Failed to load users.</div>';
  }
}

/* Results admin */
async function renderResults() {
  const out = $('#resultsArea'); 
  out.innerHTML = '<div class="small">Loading results...</div>';

  try {
    results = await loadResultsFromFirestore();
    if (results.length === 0) {
      out.innerHTML = '<div class="small">No results yet</div>';
      return;
    }

    const table = document.createElement('table'); 
    table.className = 'table';
    const thead = document.createElement('thead'); 
    thead.innerHTML = '<tr><th>User</th><th>Total %</th><th>Synopsis</th><th>Minor Practical</th><th>Major Practical</th><th>Viva</th><th>Time</th></tr>'; 
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    results.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.username}</td>
        <td>${r.totalScorePercent}</td>
        <td>${r.sectionScores['Synopsis'] || 0}</td>
        <td>${r.sectionScores['Minor Practical'] || 0}</td>
        <td>${r.sectionScores['Major Practical'] || 0}</td>
        <td>${r.sectionScores['Viva'] || 0}</td>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody); 
    out.innerHTML = ''; 
    out.appendChild(table);

  } catch (err) {
    out.innerHTML = '<div class="small danger">‚ö†Ô∏è Failed to load results</div>';
    console.error(err);
  }
}

async function clearResults(){ if(!confirm('Clear all results?')) return; try { await clearResultsFirestore(); results = []; renderResults(); alert('‚úÖ Results cleared'); } catch(err){ console.error(err); alert('‚ùå Failed to clear results'); } }

/* Exam Settings */
function updateQuestionPreview(){
  const total = (parseInt($('#adminCountSynopsis').value || 0) + parseInt($('#adminCountMinor').value || 0) + parseInt($('#adminCountMajor').value || 0) + parseInt($('#adminCountViva').value || 0));
  document.getElementById('questionPreview').textContent = `Total Questions: ${total}`;
}

async function saveExamSettings(){
  const dur = parseInt(document.getElementById('adminDuration').value) || 30;
  const msg = document.getElementById('adminCustomMsg').value || "üì¢ Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar üöÄ";
  const shuffle = document.getElementById('adminShuffle').checked;

  const countSynopsis = parseInt(document.getElementById('adminCountSynopsis').value) || 0;
  const countMinor = parseInt(document.getElementById('adminCountMinor').value) || 0;
  const countMajor = parseInt(document.getElementById('adminCountMajor').value) || 0;
  const countViva = parseInt(document.getElementById('adminCountViva').value) || 0;

  settings = {
    durationMin: dur,
    customMsg: msg,
    shuffle: shuffle,
    counts: {
      Synopsis: countSynopsis,
      "Minor Practical": countMinor,
      "Major Practical": countMajor,
      Viva: countViva
    }
  };

  try {
    await saveSettingsToFirestore(settings);
    alert("Exam settings saved online!");
  } catch(err){
    console.error(err);
    alert("‚ùå Failed to save settings online");
  }
}

function renderSettingsAdmin(){
  document.getElementById('adminDuration').value = settings.durationMin;
  document.getElementById('adminCustomMsg').value = settings.customMsg || "";
  document.getElementById('adminShuffle').checked = settings.shuffle || false;
  document.getElementById('adminCountSynopsis').value = settings.counts?.Synopsis || 0;
  document.getElementById('adminCountMinor').value = settings.counts?.["Minor Practical"] || 0;
  document.getElementById('adminCountMajor').value = settings.counts?.["Major Practical"] || 0;
  document.getElementById('adminCountViva').value = settings.counts?.Viva || 0;
  updateQuestionPreview();
}

/* ---------- Import / Export functions (work with Firestore data) ---------- */

function triggerImportUsers(){ $('#impUsersFile').click(); }
function triggerImportQuestions(){ $('#impQFile').click(); }
function triggerImportSettings() { document.getElementById('impSettingsFile').click(); }
function triggerImportResults() { document.getElementById('impResultsFile').click(); }

function importUsersFile(e){
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = async ()=> {
    try {
      const arr = JSON.parse(fr.result);
      if(!Array.isArray(arr)) throw 'bad';
      // import each user to Firestore
      for(const u of arr){
        const obj = { username: u.username, password: u.password, photo: u.photo || '', fullname: u.fullname || u.fullName || '' };
        await saveUserToFirestore(obj);
      }
      users = await loadUsersFromFirestore();
      renderUsersAdmin();
      alert('‚úÖ Users imported to Firestore');
    } catch (err) { console.error(err); alert('Invalid users JSON'); }
  };
  fr.readAsText(f);
  e.target.value = '';
}
function importQuestionsFile(e){
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = async ()=> {
    try {
      const arr = JSON.parse(fr.result);
      if(!Array.isArray(arr)) throw 'bad';
      for(const q of arr){
        const obj = { id: q.id || uid(), question: q.question || '', options: q.options || ['','','',''], answer: parseInt(q.answer)||0, marks: parseInt(q.marks)||1, category: q.category || 'Synopsis' };
        await saveQuestionToFirestore(obj);
      }
      questions = await loadQuestionsFromFirestore();
      renderQuestionsList();
      alert('‚úÖ Questions imported to Firestore');
    } catch(err){ console.error(err); alert('Invalid questions JSON'); }
  };
  fr.readAsText(f);
  e.target.value = '';
}

async function exportUsers(){
  try {
    const usersArr = await loadUsersFromFirestore();
    const blob = new Blob([JSON.stringify(usersArr, null, 2)], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'users.json';
    a.click();
    a.remove();
  } catch(err){ console.error(err); alert('Failed to export users'); }
}
async function exportQuestions(){
  try {
    const qs = await loadQuestionsFromFirestore();
    const blob = new Blob([JSON.stringify(qs, null, 2)], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'questions.json';
    a.click();
    a.remove();
  } catch(err){ console.error(err); alert('Failed to export questions'); }
}

async function downloadFullBackup(){
  try {
    const usersArr = await loadUsersFromFirestore();
    const qs = await loadQuestionsFromFirestore();
    const resultsArr = await loadResultsFromFirestore();
    const settingsObj = await loadSettingsFromFirestore();
    const backup = { users: usersArr, questions: qs, results: resultsArr, settings: settingsObj };
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'exam_full_backup.json';
    a.click();
    a.remove();
  } catch(err){ console.error(err); alert('Failed to create backup'); }
}

function importFullBackup(file) {
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const backup = JSON.parse(e.target.result);
      if(Array.isArray(backup.users)){
        for(const u of backup.users){
          await saveUserToFirestore({ username: u.username, password: u.password, photo: u.photo || '', fullname: u.fullname || u.fullName || '' });
        }
      }
      if(Array.isArray(backup.questions)){
        for(const q of backup.questions){
          await saveQuestionToFirestore({ id: q.id || uid(), question: q.question || '', options: q.options || ['','','',''], answer: parseInt(q.answer)||0, marks: parseInt(q.marks)||1, category: q.category || 'Synopsis' });
        }
      }
      if(Array.isArray(backup.results)){
        for(const r of backup.results){
          await db.collection('results').add(r);
        }
      }
      if(backup.settings) await saveSettingsToFirestore(backup.settings);
      users = await loadUsersFromFirestore();
      questions = await loadQuestionsFromFirestore();
      results = await loadResultsFromFirestore();
      settings = await loadSettingsFromFirestore() || settings;
      renderUsersAdmin();
      renderQuestionsList();
      renderResults();
      renderSettingsAdmin();
      alert("‚úÖ Full backup restored to Firestore!");
    } catch (err) {
      alert("‚ùå Invalid backup file");
      console.error(err);
    }
  };
  reader.readAsText(file);
}

async function importResultsFile(e) {
  const files = e.target.files;
  if (!files || files.length === 0) return;
  try {
    for (const file of files) {
      const fr = new FileReader();
      await new Promise((resolve, reject) => {
        fr.onload = async () => {
          try {
            const arr = JSON.parse(fr.result);
            if(!Array.isArray(arr)) throw 'bad results json';
            for(const r of arr){
              // add result doc
              await db.collection('results').add(r);
            }
            resolve();
          } catch(err) {
            console.error("Failed to import file", file.name, err);
            alert(`‚ùå Failed to import ${file.name}`);
            reject(err);
          }
        };
        fr.readAsText(file);
      });
    }
    results = await loadResultsFromFirestore();
    alert(`‚úÖ Imported ${files.length} results file(s) successfully!`);
    renderResults();
  } catch(err){
    console.error(err);
  }
  e.target.value = "";
}

function exportSettings() {
  if (!settings) return alert("No exam settings to export");
  const blob = new Blob([JSON.stringify(settings, null, 2)], { type: "application/json" });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'exam_settings.json';
  a.click();
  a.remove();
}

function importSettingsFile(e) {
  const f = e.target.files[0]; if (!f) return;
  const fr = new FileReader();
  fr.onload = async () => {
    try {
      const obj = JSON.parse(fr.result);
      if (!obj.durationMin || !obj.customMsg) throw 'bad';
      settings = {
        durationMin: obj.durationMin || 30,
        customMsg: obj.customMsg || "üì¢ Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar üöÄ",
        shuffle: obj.shuffle || false,
        counts: {
          Synopsis: obj.counts?.Synopsis || 0,
          "Minor Practical": obj.counts?.["Minor Practical"] || 0,
          "Major Practical": obj.counts?.["Major Practical"] || 0,
          Viva: obj.counts?.Viva || 0
        }
      };
      await saveSettingsToFirestore(settings);
      alert('‚úÖ Exam settings imported to Firestore!');
      renderSettingsAdmin();
    } catch(err) {
      console.error(err);
      alert('‚ùå Invalid exam settings JSON');
    }
  };
  fr.readAsText(f);
  e.target.value = '';
}

/* Export results JSON (downloads results currently in Firestore) */
async function exportResultsJSON(){
  try {
    const res = await loadResultsFromFirestore();
    if(res.length === 0) return alert('No results to export');
    const blob = new Blob([JSON.stringify(res, null, 2)], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'results.json';
    a.click();
    a.remove();
  } catch(err){
    console.error(err);
    alert('Failed to export results');
  }
}

/* Export results CSV */
async function exportResultsCSV(){
  try {
    const res = await loadResultsFromFirestore();
    if(res.length === 0) return alert('No results to export');
    const rows = [['username','totalPercent','synopsis','minor_practical','major_practical','viva','timestamp']];
    res.forEach(r => rows.push([r.username, r.totalScorePercent, r.sectionScores['Synopsis']||0, r.sectionScores['Minor Practical']||0, r.sectionScores['Major Practical']||0, r.sectionScores['Viva']||0, new Date(r.timestamp).toISOString()]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'results.csv';
    a.click();
    a.remove();
  } catch(err){
    console.error(err);
    alert('Failed to export results CSV');
  }
}

/* ---------- small UI helpers and animations ---------- */
showSection('user');
renderQuestionsList();
renderUsersAdmin();
renderResults();

const character = document.getElementById("examCharacterName");

// Smooth tracking variables
let mouseX = 0, mouseY = 0;
let charX = 0, charY = 0;
const speed = 0.15; // lower = slower lag, higher = faster

// Update mouse position
document.addEventListener('mousemove', e => {
    mouseX = e.clientX + 15; // offset
    mouseY = e.clientY + 15;
});

// Animation loop
function animate() {
    charX += (mouseX - charX) * speed;
    charY += (mouseY - charY) * speed;
    character.style.left = charX + 'px';
    character.style.top = charY + 'px';
    requestAnimationFrame(animate);
}
animate();

const ADMIN_UNLOCK_PASS = "exam123"; // üîë change this password
let examPaused = false;

// fullscreen helpers
function enterFullscreen(el) {
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}
function dismissInstructions(){
  document.getElementById('examInstructionsOverlay').style.display = 'none';
}
function unlockExam(){
  const pass = document.getElementById('unlockPassword').value;
  if(pass === ADMIN_UNLOCK_PASS){
    document.getElementById('lockScreen').style.display = 'none';
    enterFullscreen(document.documentElement);
  } else {
    alert('Wrong password');
  }
}
</script>
</body>
</html>
