<!doctype html>
<html lang="en">
<head>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC7X0B65qfWiSkSaC_-dXElw687ZmVM9gU",
    authDomain: "exam-system-2ed90.firebaseapp.com",
    projectId: "exam-system-2ed90",
    storageBucket: "exam-system-2ed90.appspot.com",
    messagingSenderId: "576581410555",
    appId: "1:576581410555:web:e38cea3f14d10e5daa5a5e",
    measurementId: "G-BCFKVMVTBE"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
  window.storage = getStorage(app);

  // ✅ Expose Firestore helpers globally
  window.setDoc = setDoc;
  window.getDoc = getDoc;
  window.getDocs = getDocs;
  window.doc = doc;
  window.collection = collection;
</script>


<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Offline MCQ Exam — Full App</title>
<style>
#fsQuestion div {
  margin: 0;     /* remove default div margins */
  padding: 0;    /* no extra space */
}
.admin-question-text {
  white-space: pre-wrap;   /* preserve newlines & spaces */
  word-wrap: break-word;   /* wrap long words */
  margin-top: 4px;
  display: block;
}
.admin-question-text {
  white-space: pre-wrap;
  word-wrap: break-word;
}
#fsQuestion {
   max-height: 40vh;  /* reduce box height */
  overflow-y: auto;
  padding: 2px 6px;    /* less inner space */
  margin-bottom: 8px;  /* less gap below */
  border-radius: 6px;
  background: transparent;
  color: #e6eef8;
  white-space: pre-wrap;
}
.exam-message {
position: fixed;     /* stick to top */
  top: 0;
  left: 0;
  width: 100%;
  overflow: hidden;
  background: #002b5c;
  color: #fff;
  padding: 8px 0;
  font-weight: bold;
  text-align: center;
  border-radius: 0 0 6px 6px;
  margin-bottom: 10px;
}

#examMsg {
  display: inline-block;
  font-size: 16px;
  animation: colorChange 3s infinite alternate;
}

@keyframes colorChange {
  0%   { color: #ffeb3b; }  /* yellow */
  25%  { color: #4caf50; }  /* green */
  50%  { color: #03a9f4; }  /* blue */
  75%  { color: #e91e63; }  /* pink */
  100% { color: #ff5722; }  /* orange */
}
#examInner {
  margin-top: 40px;
}
 :root{
    --bg:#071428; --panel:#0b1a2b; --muted:#9aa6b2; --text:#e6eef8;
    --brand:#60a5fa; --good:#34d399; --danger:#f87171;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:linear-gradient(180deg,#061026,#071428)}
  .wrap{max-width:1100px;margin:20px auto;padding:18px}
  .header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{font-weight:800;font-size:20px}
  .hint{color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .row{display:flex;gap:10px;align-items:center}
  .spacer{flex:1}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type="text"], input[type="password"], input[type="number"], textarea, select { width:100%; padding:8px; border-radius:8px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); }
  textarea{
min-height:80px
 resize: vertical;
  padding: 8px;
  line-height: 1.4;
  vertical-align: top;
  text-align: left;}
  .btn{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn.brand{background:var(--brand);color:#042033}
  .btn.warn{background:var(--good);color:#042033}
  .btn.danger{background:var(--danger);color:white}
  .small{font-size:12px;color:var(--muted)}
  .hidden{display:none!important}
  .list { max-height:320px; overflow:auto; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); padding:8px }
  .list-item{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; gap:8px; align-items:center; }
  .badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02); color:var(--muted); font-weight:700; font-size:12px}
  /* Fullscreen exam */
  #examFullscreen{position:fixed;inset:0;background:linear-gradient(180deg,#041022,#041b2a);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
  #examInner{width:min(1100px,96%);background:linear-gradient(180deg,#061426,#07182a);border-radius:14px;padding:22px;display:flex;gap:20px;align-items:flex-start;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
  #fsUser{flex:0 0 220px;text-align:center}
  #fsUser img{width:160px;height:160px;border-radius:50%;object-fit:cover;border:4px solid rgba(255,255,255,0.04)}
  #fsUser h2{margin:12px 0 6px;font-size:20px}
  #fsMain {
  flex: 1;
  min-width: 320px;
  display: flex;
  flex-direction: column;
  max-height: 70vh; /* limit height on small screens */
}
#fsQuestion, #fsOptions {
  flex-shrink: 0;
}
#fsScrollArea {
  flex: 1;
  overflow-y: auto;   /* only this part scrolls */
  margin-bottom: 8px;
}
  .fsQuestion{font-size:20px;font-weight:700;margin-bottom:14px}
  .fsOptions{display:grid;gap:10px}
  .fsOpt{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:flex;gap:10px;align-items:center}
  .fsOpt.selected{outline:3px solid white;background:linear-gradient(90deg,rgba(96,165,250,0.04),transparent)}

.fsFooter {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #07182a;
  position: sticky;
  bottom: 0;
  z-index: 20;
}

  .timer{font-weight:900;font-variant-numeric:tabular-nums}
  .progress-bar{width:100%;background:rgba(255,255,255,0.03);height:18px;border-radius:999px;margin-top:12px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#34d399,#60a5fa);width:0%;transition:width 800ms ease}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{background:rgba(255,255,255,0.02)}
  /* responsive */
  @media (max-width:900px){
    #examInner{flex-direction:column;align-items:center}
    #fsUser{order:1}
    #fsMain{order:2;width:100%}
  }
.userPhoto {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
}
  #examCharacter {
  position: fixed;
  top: 50px;
  left: 50px;
  width: 60px;       /* size of your character */
  height: 60px;
  pointer-events: none; /* so it won’t block clicks */
  transition: transform 0.1s linear; /* smooth movement */
  z-index: 9999;
}
.answer-stats {
  margin-top: 6px;
  font-size: 14px;
  color: var(--muted);
  text-align: center;
}
.answer-stats span {
  margin: 0 8px;
}

@media (max-width:600px){
  body { font-size: 14px; }
  .brand { font-size: 16px; }
  h3 { font-size: 16px; }
  .btn { padding: 6px 10px; font-size: 14px; }
}
@media (max-width:600px){
  .btn { width: 100%; margin-bottom: 6px; }
  .row { flex-direction: column; align-items: stretch; }
}
@media (max-width:600px){
  #fsUser img { width: 100px; height: 100px; }
}
/* Compact grid of question numbers on mobile */
@media (max-width:600px){
  #questionNav {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
    gap: 6px;
    padding: 8px 4px;
  }
  #questionNav button {
    min-width: 40px;
    height: 40px;
    font-size: 14px;
    text-align: center;
    border-radius: 6px; /* square with rounded edges */
    padding: 0;
  }
}

</style>
</head>
<body>
<div class="wrap card">
  <div class="header">
    <div>
      <div class="brand" id="examHeader">
  <!-- filled by JS -->
</div>

      <div class="hint">Offline • localStorage • Import/Export • Admin results</div>
    </div>
    <div class="row">
      <button class="btn brand" onclick="showSection('user')">User</button>
      <button class="btn" onclick="showSection('import')">Import/Export</button>
      <button class="btn" onclick="showSection('adminLogin')">Admin Login</button>
    </div>
  </div>

  <!-- USER SECTION -->
  <section id="user">
    <div class="card">
      <h3>User Login / Register</h3>
      <div class="row" style="gap:12px">
        <div style="flex:1">
          <label>Username</label>
          <input id="userName" class="input" type="text" placeholder="username (e.g. rahul)">
        </div>
        <div style="width:220px">
          <label>Photo (first-time)</label>
          <input id="userPhoto" type="file" accept="image/*">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Password</label>
          <input id="userPass" type="password">
        </div>
        <div style="width:160px;align-self:end">
          <button class="btn brand" onclick="handleUserLogin()">Login / Register</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">If username exists, enter the same password to login. New users must upload photo to register.</div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <h3>Quick Import / Export</h3>
      <div class="row">
        <button class="btn" onclick="triggerImportUsers()">Import Users (.json)</button>
        <button class="btn" onclick="triggerImportQuestions()">Import Questions (.json)</button>
        <div class="spacer"></div>
        <button class="btn" onclick="exportUsers()">Export Users (.json)</button>
        <button class="btn" onclick="exportQuestions()">Export Questions (.json)</button>
      </div>
      <div class="small" style="margin-top:8px">App auto-loads previously stored users & questions on page load.</div>
    </div>
  </section>

  <!-- IMPORT / EXPORT -->
  <section id="import" class="hidden">
    <div class="card">
      <h3>Import / Export</h3>
      <div class="row">
        <div style="flex:1">
          <label>Import Users (JSON file with array of {username,password,photo})</label>
          <input id="impUsersFile" type="file" accept="application/json" onchange="importUsersFile(event)">
        </div>
        <div style="width:220px">
          <label>Import Questions (.json)</label>
          <input id="impQFile" type="file" accept="application/json" onchange="importQuestionsFile(event)">
        </div>
      </div>
<div style="height:12px"></div>
<div class="row">
  <button class="btn" onclick="exportSettings()">Export Exam Settings (.json)</button>
  <button class="btn" onclick="triggerImportSettings()">Import Exam Settings (.json)</button>
  <input id="impSettingsFile" type="file" accept="application/json" onchange="importSettingsFile(event)" style="display:none">
</div>

      <div style="height:12px"></div>
    <div class="row">
  <button class="btn" onclick="exportUsers()">Export Users (.json)</button>
  <button class="btn" onclick="exportQuestions()">Export Questions (.json)</button>
  <div class="spacer"></div>
  <button class="btn warn" onclick="downloadBackup()">Download Full Backup (.json)</button>
  <button class="btn" onclick="updateBackup()">Update Full Backup</button> <!-- ✅ new -->
</div>


<div class="row" style="margin-top:10px">
  <label class="btn">
    Import Full Backup (.json)
    <input type="file" id="importBackupFile" accept="application/json"
           style="display:none"
           onchange="importFullBackup(this.files[0])">
  </label>
</div>

<div class="small" style="margin-top:8px">
  Photos must be base64 data URLs in the users JSON to be portable (we export that way).
</div>
</section>

  <!-- ADMIN LOGIN -->
  <section id="adminLogin" class="hidden">
    <div class="card">
      <h3>Admin Login</h3>
      <label>Admin password</label>
      <input id="adminPass" type="password" value="">
      <div class="row" style="margin-top:10px">
        <button class="btn brand" onclick="handleAdminLogin()">Login</button>
        <div class="spacer"></div>
        <div class="small">Made by: <b>Ranjan Kumar</b></div>
      </div>
    </div>
  </section>

  <!-- ADMIN PANEL (visible after login) -->
<section id="adminPanel" class="hidden">

  <!-- Exam Settings Card -->
<label>Logo</label>
<input id="adminLogo" type="file" accept="image/*">

<label>Author</label>
<input id="adminAuthor" type="text" placeholder="e.g. Ranjan Kumar">

<label>College Name</label>
<input id="adminCollege" type="text" placeholder="e.g. Regional College of Pharmaceutical Sciences">

<label>Subject</label>
<input id="adminSubject" type="text" placeholder="e.g. Computer Applications in Pharmacy">

<label>Subject Code</label>
<input id="adminSubjectCode" type="text" placeholder="e.g. BP210P">

<label>Full Marks</label>
<input id="adminFullMarks" type="number" min="0" placeholder="e.g. 20">

<label style="margin-top:8px">Synopsis Questions</label>
<input id="adminCountSynopsis" type="number" min="0" value="2" oninput="updateQuestionPreview()"/>

<label style="margin-top:8px">Minor Practical Questions</label>
<input id="adminCountMinor" type="number" min="0" value="2" oninput="updateQuestionPreview()"/>

<label style="margin-top:8px">Major Practical Questions</label>
<input id="adminCountMajor" type="number" min="0" value="1" oninput="updateQuestionPreview()"/>

<label style="margin-top:8px">Viva Questions</label>
<input id="adminCountViva" type="number" min="0" value="2" oninput="updateQuestionPreview()"/>


<div id="questionPreview" class="small" style="margin-top:8px; font-weight:bold; color:#2563eb;">
  Total Questions: 0
</div>

  <div class="card">
    <h3>Exam Settings</h3>
    <label>Exam Duration (minutes)</label>
<label style="margin-top:8px">Number of Questions</label>
<label style="margin-top:8px">
  <input type="checkbox" id="adminShuffle"> Shuffle Questions
</label>
<label style="margin-top:8px">
  <input type="checkbox" id="adminAllowAfterTime"> Allow answering after time ends
</label>

<input id="adminTotalQs" type="number" min="1" value="10"/>
    <input id="adminDuration" type="number" min="1" value="30"/>
<label style="margin-top:8px">Custom Exam Message</label>
  <input id="adminCustomMsg" type="text" value="📢 Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar 🚀"/>
    <div class="row" style="margin-top:8px">
      <button class="btn brand" onclick="saveExamSettings()">Save Settings</button>
    </div>
    <div class="small">This duration will apply to all new exams.</div>
  </div>

  <div style="height:12px"></div>

  <!-- Question Bank Card -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div style="flex:1">
        <h3>Question Bank — Add / Edit</h3>
        <label>Category</label>
        <select id="qCategory">
          <option>Synopsis</option>
          <option>Minor Practical</option>
          <option>Major Practical</option>
          <option>Viva</option>
        </select>
        <label style="margin-top:8px">Question</label>
        <textarea id="qText"></textarea>
        <label>Option A</label><input id="qA" type="text"/>
        <label>Option B</label><input id="qB" type="text"/>
        <label>Option C</label><input id="qC" type="text"/>
        <label>Option D</label><input id="qD" type="text"/>
        <div class="row" style="margin-top:8px;align-items:center">
          <div style="width:160px">
            <label>Correct answer</label>
            <select id="qAnswer">
              <option value="0">A</option>
              <option value="1">B</option>
              <option value="2">C</option>
              <option value="3">D</option>
            </select>
          </div>
          <div style="width:120px">
            <label>Marks</label>
            <input id="qMarks" type="number" min="1" value="1"/>
          </div>
          <div class="spacer"></div>
          <button class="btn brand" onclick="saveQuestion()">Save</button>
          <button class="btn danger" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>

      <div style="width:420px;min-width:280px">
        <h3>Questions</h3>
        <div id="questionsList" class="list"></div>
        <div style="margin-top:8px" class="row">
          <button class="btn" onclick="exportQuestions()">Export questions (.json)</button>
          <button class="btn danger" onclick="clearAllQuestions()">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- Users Card -->
  <div class="card">
    <h3>Users</h3>
    <div class="row">
      <div style="flex:1">
        <label>Username</label><input id="adminNewUser" type="text"/>
<label>Full Name</label><input id="adminNewFull" type="text"/>
        <label>Password</label><input id="adminNewPass" type="text"/>
        <label>Photo</label><input id="adminNewPhoto" type="file" accept="image/*"/>
        <div class="row" style="margin-top:8px">
          <button class="btn brand" onclick="adminCreateUser()">Create / Update</button>
          <button class="btn danger" onclick="adminClearUsers()">Delete All Users</button>
        </div>
      </div>
      <div style="width:360px">
        <h4>Existing Users</h4>
        <div id="adminUsersList" class="list"></div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- Results Card -->
  <div class="card">
    <h3>Results</h3>
    <div class="row">
      <button class="btn" onclick="renderResults()">Refresh</button>
      <button class="btn" onclick="exportResultsJSON()">Export results (.json)</button>
      <button class="btn" onclick="triggerImportResults()">Import results (.json)</button>
      <button class="btn" onclick="exportResultsCSV()">Export results (.csv)</button>
      <div class="spacer"></div>
      <button class="btn danger" onclick="clearResults()">Clear Results</button>
    </div>
    <input id="impResultsFile" type="file" accept="application/json" multiple onchange="importResultsFile(event)" style="display:none">
    <div id="resultsArea" style="margin-top:10px; max-height:360px; overflow:auto"></div>
  </div>

</section>


  <div style="height:12px"></div>
  <div class="small">Tip: All data stored locally in this browser. Use export/import to move data between machines.</div>
</div>

<!-- Fullscreen exam -->
<div id="examFullscreen">
<!-- Instructions Overlay -->
<div id="examInstructionsOverlay" 
     style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; 
            background:rgba(0,0,0,0.9); z-index:10000;">
  <div style="max-width:700px; background:#0b1a2b; padding:20px; border-radius:12px; 
              color:#e6eef8; text-align:left; box-shadow:0 0 25px rgba(0,0,0,0.6)">
    <h2 style="text-align:center; color:#60a5fa;">📘 Exam Instructions</h2>
    <ul style="margin-top:12px; line-height:1.6;">
      <li>✅ Stay in fullscreen mode during the exam. Exiting will pause the test.</li>
      <li>✅ Do not refresh or close the browser during the exam.</li>
      <li>✅ Use the navigation buttons to move between questions.</li>
      <li>✅ You may flag questions for review before submission.</li>
      <li>✅ Timer will count down automatically. Submit before time runs out.</li>
      <li>✅ Results will be shown immediately after submission.</li>
    </ul>
    <div style="text-align:center; margin-top:20px;">
      <button onclick="dismissInstructions()" 
              style="padding:10px 20px; font-size:16px; font-weight:bold; 
                     border-radius:10px; background:#34d399; color:#042033; cursor:pointer;">
        🚀 Start Exam
      </button>
    </div>
  </div>
</div>

  <!-- 🔹 Custom Animated Message (top banner) -->
  <div class="exam-message">
     <div id="examMsg">📢 Welcome to your exam! Best of luck 🚀 </div>
  </div>
<div id="examCharacterName" 
     style="
       position: absolute;
       font-size: 24px;
       font-weight: bold;
       color: #60a5fa;
       pointer-events: none;
       user-select: none;
       z-index: 9999;
     ">
</div>
<!-- 🔒 Lock screen when exam is paused -->
<div id="lockScreen"
     style="position:fixed;inset:0;background:rgba(0,0,0,0.85);
            color:white;display:none;flex-direction:column;align-items:center;
            justify-content:center;z-index:10000;">
  <h2>⚠️ Exam Paused</h2>
  <p>You exited fullscreen mode. Enter the password to continue.</p>
  <input type="password" id="unlockPassword" placeholder="Enter password"
         style="padding:8px;margin-top:10px">
  <button onclick="unlockExam()" 
          style="padding:8px 15px;margin-top:10px;cursor:pointer;">
    Unlock & Resume
  </button>
</div>

  <div id="examInner">
    <div id="fsUser">
      <img id="fsPhoto" src="" alt="photo">
      <h2 id="fsName"></h2>
      <div class="small" id="fsMeta"></div>
 <div id="answerStats" class="answer-stats"></div>
    </div>
    <div id="fsMain">
      <div id="fsScrollArea">
  <div id="fsQuestion">Question will appear here</div>
  <div id="fsOptions"></div>
</div>

      <!-- NEW: Direct question navigation -->
      <div id="questionNav" style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0;"></div>

      <div class="fsFooter">
        <div style="display:flex;gap:8px;">
          <button class="btn" onclick="toggleFlag()">⚑ Flag</button>
          <button class="btn" onclick="prevQuestion()">⟵ Prev</button>
          <button class="btn" onclick="nextQuestion()">Next ⟶</button>
        </div>
        <div class="spacer"></div>
        <div class="timer" id="fsTimer">00:00:00</div>
        <button class="btn warn" onclick="submitExam()">Submit</button>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="fsProgressFill"></div></div>
    </div>
  </div>
<div id="answerStats" class="answer-stats"></div>

</div>


<script>
async function saveToFirestore(collectionName, id, data, localKey=null) {
  try {
    if (localKey) write(localKey, data); // keep offline copy
    await setDoc(doc(db, collectionName, id), data);
    console.log(`✅ Firestore saved: ${collectionName}/${id}`);
    return true;
  } catch (err) {
    console.warn("⚠️ Firestore save failed, local only", err);
    return false;
  }
}

/* -------------------------
   Storage keys & defaults
   ------------------------- */
const K_USERS = 'offline_mcq_users_v1';
const K_QS = 'offline_mcq_qs_v1';
const K_RESULTS = 'offline_mcq_results_v1';
const K_ADMIN = 'offline_mcq_admin_v1';

const MASTER_ADMIN = { username: 'admin', password: 'admin123' };
const K_SETTINGS = 'offline_mcq_settings_v1';

/* Helpers */
const $ = s => document.querySelector(s);
const $all = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2,9);
const read = (k,def) => { try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; } }
const write = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const download = (filename, content, type='text/plain') => {
  const blob = new Blob([content], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
};
// Escape HTML to show tags as plain text
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
}
// Text encoder/decoder
const enc = new TextEncoder();
const dec = new TextDecoder();

// Fixed secret key (you can also ask admin for password to generate this)
const SECRET_KEY = "exam-secret-key-123"; 

// Derive AES key from secret string
async function getKey() {
  const keyMaterial = await crypto.subtle.importKey(
    "raw", enc.encode(SECRET_KEY), { name: "PBKDF2" }, false, ["deriveKey"]
  );
  return crypto.subtle.deriveKey(
    { name: "PBKDF2", salt: enc.encode("exam-salt"), iterations: 1000, hash: "SHA-256" },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}

async function encryptData(obj) {
  const key = await getKey();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = enc.encode(JSON.stringify(obj));
  const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, data);
  return { iv: Array.from(iv), data: btoa(String.fromCharCode(...new Uint8Array(encrypted))) };
}

async function decryptData(encObj) {
  const key = await getKey();
  const iv = new Uint8Array(encObj.iv);
  const data = Uint8Array.from(atob(encObj.data), c => c.charCodeAt(0));
  const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
  return JSON.parse(dec.decode(decrypted));
}


/* Load or seed data */
let users = read(K_USERS, []);
let questions = read(K_QS, []);
let results = read(K_RESULTS, []);
let adminCred = read(K_ADMIN, null);
let settings = read(K_SETTINGS, { 
  durationMin: 30, 
  customMsg: "📢 Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar 🚀",
  shuffle: false,
  counts: {
    Synopsis: 2,
    "Minor Practical": 2,
    "Major Practical": 1,
    Viva: 2
  }
});



if(!adminCred) write(K_ADMIN, MASTER_ADMIN);

if(questions.length === 0){
  // seed sample questions
  questions = [
    { id: uid(), question: 'HTML stands for?', options: ['Hyperlinks Text Markup','Home Tool Markup','Hyper Text Markup Language','Hyperlinking Text Markdown'], answer: 2, marks: 1, category: 'Synopsis' },
    { id: uid(), question: 'Which tag defines paragraph?', options: ['<p>','<para>','<pg>','<par>'], answer: 0, marks: 1, category: 'Minor Practical' },
    { id: uid(), question: 'Which method adds to array end?', options: ['push','pop','shift','unshift'], answer: 0, marks: 2, category: 'Major Practical' },
    { id: uid(), question: 'Does localStorage persist after browser restart?', options: ['Yes','No','Sometimes','Depends'], answer: 0, marks: 1, category: 'Viva' }
  ];
  write(K_QS, questions);
}
function downloadBackup() {
  const backup = {
    users,
    questions,
    results,
    settings,
    adminCred
  };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "exam_full_backup.json";
  a.click();
}

function importFullBackup(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const backup = JSON.parse(e.target.result);

      users = backup.users || [];
      questions = backup.questions || [];
      results = backup.results || [];
      settings = {
  durationMin: backup.settings?.durationMin || 30,
  customMsg: backup.settings?.customMsg || "📢 Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar 🚀",
  shuffle: backup.settings?.shuffle || false,
  counts: {
    Synopsis: backup.settings?.counts?.Synopsis || 0,
    "Minor Practical": backup.settings?.counts?.["Minor Practical"] || 0,
    "Major Practical": backup.settings?.counts?.["Major Practical"] || 0,
    Viva: backup.settings?.counts?.Viva || 0
  }
};

      adminCred = backup.adminCred || MASTER_ADMIN;

      write(K_USERS, users);
      write(K_QS, questions);
      write(K_RESULTS, results);
      write(K_SETTINGS, settings);
      write(K_ADMIN, adminCred);

      alert("✅ Full backup restored!");
      renderUsersAdmin();
      renderQuestionsList();
      renderResults();
    } catch (err) {
      alert("❌ Invalid backup file");
      console.error(err);
    }
  };
  reader.readAsText(file);
}

function updateBackup() {
  const backup = {
    users,
    questions,
    results,
    settings,
    adminCred
  };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "exam_full_backup.json"; // same name every time
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);

  alert("✅ Backup updated! Please replace the old file when saving.");
}

/* UI: show sections */
function showSection(id){
  ['user','import','adminLogin','adminPanel'].forEach(s => { const el = document.getElementById(s); if(!el) return; el.classList.add('hidden'); });
  document.getElementById(id).classList.remove('hidden');
  if(id === 'adminPanel') {
    renderQuestionsList();
    renderUsersAdmin();
    renderResults();
  }
}

/* ---------- USER FLOW ---------- */

/* convert File -> base64 data URL */
function fileToDataURL(file){ return new Promise(res => { const fr = new FileReader(); fr.onload = ()=> res(fr.result); fr.readAsDataURL(file); }); }

/* handle login/register */
async function handleUserLogin(){
  const username = $('#userName').value.trim();
  const pass = $('#userPass').value;
  const file = document.getElementById('userPhoto').files[0];

  if(!username || !pass) return alert('Enter username and password');

  let user = users.find(u => u.username === username && u.password === pass);
  if(!user){
    // register new
    if(!file) return alert('New user: upload photo to register');
    const photo = await fileToDataURL(file);

    // 🔹 Ask full name from username input OR default to username
    const fullName = username; 

    user = { username, password: pass, photo, fullName };
    users.push(user); 
   saveToFirestore("users", user.username, user);

  }
  startExam(user);
}


/* ---------------- EXAM RUNTIME (fullscreen) ---------------- */

let EXAM = {
  paper: [],      // array of questions (copied)
  state: null,    // {username,answers:{qId:choice},flags:{qId:true},startedAt,remainingMs,submitted}
  timerId: null,
  cur: 0,
  cfg: { durationMin: 30, total: null, shuffle: false } // default
};

function buildPaper(qbank, shuffle){
  let selected = [];

  // group by category
  const byCategory = {
    Synopsis: qbank.filter(q => q.category === "Synopsis"),
    "Minor Practical": qbank.filter(q => q.category === "Minor Practical"),
    "Major Practical": qbank.filter(q => q.category === "Major Practical"),
    Viva: qbank.filter(q => q.category === "Viva")
  };

  // helper to pick random questions
  function pickRandom(arr, count){
    const copy = arr.slice();
    const chosen = [];
    for (let i = 0; i < count && copy.length > 0; i++) {
      const idx = Math.floor(Math.random() * copy.length);
      chosen.push(copy.splice(idx,1)[0]);
    }
    return chosen;
  }

  // pick based on settings.counts
  for (let cat in settings.counts){
    if (byCategory[cat]) {
      selected = selected.concat(pickRandom(byCategory[cat], settings.counts[cat]));
    }
  }

  // shuffle overall exam if enabled
  if (shuffle) {
    for (let i = selected.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [selected[i], selected[j]] = [selected[j], selected[i]];
    }
  }

  return selected.map(q => ({
    id: q.id,
    question: q.question,
    options: q.options,
    answer: q.answer,
    marks: q.marks,
    category: q.category
  }));
}

function startExam(user){
enterFullscreen(document.documentElement); // force fullscreen
  // config: use all questions by default
  EXAM.cfg.total = settings.totalQs || questions.length;
EXAM.cfg.shuffle = settings.shuffle || false;
  EXAM.cfg.durationMin = settings.durationMin || 30;
document.getElementById("examMsg").textContent = settings.customMsg;
document.getElementById("examCharacterName").textContent = user.fullName || user.username;


  EXAM.paper = buildPaper(questions, EXAM.cfg.shuffle);
  EXAM.state = { username: user.username, answers: {}, flags: {}, startedAt: Date.now(), remainingMs: EXAM.cfg.durationMin * 60 * 1000, submitted: false };
  EXAM.cur = 0;

  // show fullscreen modal
  $('#examFullscreen').style.display = 'flex';
  $('#fsPhoto').src = user.photo || '';
 $('#fsName').textContent = user.fullName || user.username;
  paintQuestion();
  startTimer();
}

function paintQuestion() {
  const q = EXAM.paper[EXAM.cur];
  if (!q) return;

  // ✅ Question text directly, no leading newline/space
  $('#fsQuestion').innerHTML =
    `${EXAM.cur+1}. (${q.category}) ${escapeHTML(q.question)}`;

  // render options
  const opts = $('#fsOptions'); 
  opts.innerHTML = '';

  q.options.forEach((opt, i) => {
    const d = document.createElement('div');
    d.className = 'fsOpt' + (EXAM.state.answers[q.id] === i ? ' selected' : '');

    // option text
    d.innerHTML = `
      <div style="width:28px;font-weight:800">${String.fromCharCode(65+i)}.</div>
      <div style="flex:1">${escapeHTML(opt)}</div>
    `;

    d.onclick = () => { 
      EXAM.state.answers[q.id] = i; 
      paintQuestion(); 
      updateProgress(); 
    };

    opts.appendChild(d);
  });

  // meta info
  $('#fsMeta').textContent = 
    `Question ${EXAM.cur+1} of ${EXAM.paper.length} • Answered: ${Object.keys(EXAM.state.answers).length}`;
  
  if (EXAM.state.flags[q.id]) {
    $('#fsMeta').textContent += " • ⚑ Flagged";
  }

  updateProgress();
  renderQuestionNav(); // refresh navigation buttons
updateStats();

}

function prevQuestion(){ if(EXAM.cur>0){ EXAM.cur--; paintQuestion(); } }
function nextQuestion(){ if(EXAM.cur < EXAM.paper.length - 1){ EXAM.cur++; paintQuestion(); } }

function toggleFlag(){ const q = EXAM.paper[EXAM.cur]; if(!q) return; EXAM.state.flags[q.id] = !EXAM.state.flags[q.id]; paintQuestion(); }

function updateProgress(){ const answered = Object.keys(EXAM.state.answers).length; const total = EXAM.paper.length; const pct = Math.round((answered/total) * 100); $('#fsProgressFill').style.width = pct + '%'; }

/* NEW: Question navigator */
function renderQuestionNav(){
  const nav = document.getElementById('questionNav');
  nav.innerHTML = '';
  EXAM.paper.forEach((q,i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = i+1;
    // mark answered
    if(EXAM.state.answers[q.id] !== undefined) btn.style.background = '#34d399';
    // highlight current
    if(i === EXAM.cur) btn.style.outline = '2px solid #60a5fa';
    btn.onclick = ()=>{ EXAM.cur = i; paintQuestion(); };
    nav.appendChild(btn);
  });
}

/* Timer */
function startTimer(){
  stopTimer();
  const end = Date.now() + EXAM.state.remainingMs;
  updateTimerText();
  EXAM.timerId = setInterval(()=> {
    EXAM.state.remainingMs = end - Date.now();
   if(EXAM.state.remainingMs <= 0){
  EXAM.state.remainingMs = 0;
  stopTimer();

  if (settings.allowAfterTime) {
    alert("⏰ Time is over! You may still continue answering (admin allowed).");
    // Do NOT submit, just stop timer
  } else {
    submitExam(true);  // auto-submit if not allowed
  }
}

    updateTimerText();
  }, 500);
}
function stopTimer(){ if(EXAM.timerId){ clearInterval(EXAM.timerId); EXAM.timerId = null; } }
function updateTimerText(){ const ms = Math.max(0, EXAM.state.remainingMs); $('#fsTimer').textContent = msToTime(ms); }
function msToTime(ms){ const s = Math.floor(ms/1000); const hh = String(Math.floor(s/3600)).padStart(2,'0'); const mm = String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }

/* Submit exam: calculate marks, per-section scores, save results, show percent & progress bar only */
function renderQuestionNav(){
  const nav = document.getElementById('questionNav');
  nav.innerHTML = '';
  EXAM.paper.forEach((q,i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = i+1;
    if(EXAM.state.answers[q.id] !== undefined) {
  btn.style.background = '#34d399'; // green if answered
}
if(EXAM.state.flags[q.id]) {
  btn.style.border = '2px solid orange'; // orange border for flagged
}
if(i === EXAM.cur) {
  btn.style.outline = '2px solid #60a5fa'; // blue outline for current
}

    btn.onclick = ()=>{ EXAM.cur = i; paintQuestion(); };
    nav.appendChild(btn);
  });
}

function submitExam(auto=false){
  if(!auto && !confirm('Submit exam now?')) return;
  stopTimer();
  const paper = EXAM.paper;
  let totalMarks = 0, earned = 0;
  const sectionScores = { 'Synopsis':0, 'Minor Practical':0, 'Major Practical':0, 'Viva':0 };

paper.forEach(q => { 
  totalMarks += (q.marks || 1); 
  const chosen = EXAM.state.answers[q.id]; 

  if(q.category === "Major Practical") {
    if(chosen === 0) { // A → full marks
      earned += q.marks;
      sectionScores[q.category] += q.marks;
    } 
    else if(chosen === 1) { // B → 75%
      const val = Math.round(q.marks * 0.75);
      earned += val;
      sectionScores[q.category] += val;
    }
    else if(chosen === 2) { // C → 50%
      const val = Math.round(q.marks * 0.5);
      earned += val;
      sectionScores[q.category] += val;
    }
    else { // D → 0
      // no marks
    }
  } else {
    if(chosen === q.answer) {   // ✅ only add if correct
      earned += (q.marks || 1); 
      sectionScores[q.category] = (sectionScores[q.category] || 0) + (q.marks || 1); 
    }
  }
});

  // round marks before calculating percentage
  earned = Math.round(earned);
  Object.keys(sectionScores).forEach(k => { sectionScores[k] = Math.round(sectionScores[k]); });

  const percent = Math.round((earned / Math.max(1, totalMarks)) * 100);

(async () => {
  const record = { 
    username: EXAM.state.username, 
    totalScorePercent: percent, 
    sectionScores, 
    timestamp: Date.now() 
  };
  // 🔹 Save to Firebase (in parallel with localStorage)
  saveToFirestore("results", uid(), record);

  // Load the latest results from storage (decrypt first if exists)
  let current = [];
  const stored = read(K_RESULTS, null);
  if (stored) {
    try {
      current = await decryptData(stored);
    } catch (e) {
      console.warn("Failed to decrypt existing results, starting fresh", e);
      current = [];
    }
  }

  current.push(record);

  // 🔒 Encrypt before saving
  const encryptedResults = await encryptData(current);
  write(K_RESULTS, encryptedResults);

  // ✅ also update the global variable (keep it in sync)
  results = current;

  // Auto-download encrypted JSON
  const filename = `results_${EXAM.state.username}_${Date.now()}.json`;
  download(filename, JSON.stringify(encryptedResults, null, 2), 'application/json');
})();

  // show score
  $('#fsQuestion').innerHTML = `
    <div style="text-align:center;font-size:22px;font-weight:900">
      Your Score: ${percent}%
    </div>
    <div id="redirectMsg" style="text-align:center;margin-top:10px;font-size:14px;color:var(--muted)">
      Redirecting in 5s...
    </div>
  `;
  $('#fsOptions').innerHTML = `<div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>`;

  document.querySelectorAll('.fsFooter').forEach(el => el.style.display = 'flex');
  EXAM.state.submitted = true;

  let secs = 5;
  const msgEl = document.getElementById('redirectMsg');
  const countdown = setInterval(()=>{
    secs--;
    if(secs > 0){
      msgEl.textContent = `Redirecting in ${secs}s...`;
    } else {
      clearInterval(countdown);
      $('#examFullscreen').style.display = 'none';
      showSection('user');
    }
  }, 1000);
}


/* Close fullscreen and return to main page (reload to refresh admin view) */
function closeFullscreen(){ stopTimer(); $('#examFullscreen').style.display = 'none'; location.reload(); }

/* ---------- ADMIN: login, CRUD, import/export, results ---------- */

function handleAdminLogin(){
  const pass = $('#adminPass').value;
  const stored = read(K_ADMIN, null);
  if(stored && stored.password === pass){ enterAdmin(); return; }
  if(pass === MASTER_ADMIN.password){ enterAdmin(); return; }
  alert('Invalid admin password');
}
function enterAdmin(){
  // show admin panel
  showSection('adminPanel');
  renderQuestionsList();
  renderUsersAdmin();
  renderResults();
renderSettingsAdmin();
}

/* Questions CRUD in admin */
let editingId = null;
/* ---------- Save Question ---------- */
async function saveQuestion() {
  const text = $('#qText').value.trim();
  const opts = [$('#qA').value.trim(), $('#qB').value.trim(), $('#qC').value.trim(), $('#qD').value.trim()];
  const ans = parseInt($('#qAnswer').value) || 0;
  const marks = parseInt($('#qMarks').value) || 1;
  const category = $('#qCategory').value;

  if (!text || opts.some(o => !o)) {
    alert('⚠️ Fill question and all 4 options');
    return;
  }

  const q = {
    id: editingId || uid(),
    question: text,
    options: opts,
    answer: ans,
    marks,
    category
  };

  if (editingId) {
    questions = questions.map(x => x.id === q.id ? q : x);
    editingId = null;
  } else {
    questions.push(q);
  }

  write(K_QS, questions);

  try {
   await setDoc(doc(db, "questions", q.id), q);
await loadQuestionsFromFirestore();  // ✅ reload latest from Firestore
renderQuestionsList();


    console.log(`✅ Firestore saved: questions/${q.id}`);
    alert("✅ Question saved to Firebase + localStorage!");
  } catch (err) {
    console.error("❌ Firestore error:", err);
    alert("⚠️ Question saved offline only.\nError: " + err.message);
  }

  clearQuestionForm();
  renderQuestionsList();
}

function clearQuestionForm(){ editingId = null; $('#qText').value=''; $('#qA').value=''; $('#qB').value=''; $('#qC').value=''; $('#qD').value=''; $('#qMarks').value=1; $('#qAnswer').value='0'; $('#qCategory').value='Synopsis'; }
function cancelEdit(){ clearQuestionForm(); }
function renderQuestionsList() {
  const out = $('#questionsList'); 
  out.innerHTML = '';
  if (questions.length === 0) { 
    out.innerHTML = '<div class="small">No questions yet.</div>'; 
    return; 
  }

  questions.forEach((q, i) => {
    const wrapper = document.createElement('div'); 
    wrapper.className = 'list-item';

    const textDiv = document.createElement('div');
    textDiv.style.flex = '1';

    textDiv.innerHTML = `
      <b>${i+1}. [${q.category}]</b>
      <div class="admin-question-text">${escapeHTML(q.question)}</div>
      <div class="small">A) ${escapeHTML(q.options[0])} 
      • B) ${escapeHTML(q.options[1])} 
      • C) ${escapeHTML(q.options[2])} 
      • D) ${escapeHTML(q.options[3])}</div>
      <div class="small">Marks: ${q.marks}</div>
    `;

    const editBtn = document.createElement('button'); 
    editBtn.className = 'btn'; 
    editBtn.textContent = 'Edit'; 
    editBtn.onclick = () => { loadQuestionToForm(q.id); };

    const delBtn = document.createElement('button'); 
    delBtn.className = 'btn danger'; 
    delBtn.textContent = 'Delete'; 
    delBtn.onclick = () => { 
      if (confirm('Delete question?')) { 
        questions = questions.filter(x => x.id !== q.id); 
        write(K_QS, questions); 
        renderQuestionsList(); 
      } 
    };

    wrapper.appendChild(textDiv);
    wrapper.appendChild(editBtn);
    wrapper.appendChild(delBtn);

    out.appendChild(wrapper);
  });
}

function loadQuestionToForm(id){
  const q = questions.find(x=>x.id===id); if(!q) return;
  editingId = q.id;
  $('#qText').value = q.question; $('#qA').value=q.options[0]; $('#qB').value=q.options[1]; $('#qC').value=q.options[2]; $('#qD').value=q.options[3];
  $('#qAnswer').value = String(q.answer); $('#qMarks').value = String(q.marks); $('#qCategory').value = q.category;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function clearAllQuestions(){ if(!confirm('Delete ALL questions?')) return; questions = []; write(K_QS, questions); renderQuestionsList(); }

/* ---------------- USERS ADMIN ---------------- */
async function toDataURL(file){ 
  return new Promise(res => { 
    const fr = new FileReader(); 
    fr.onload = ()=> res(fr.result); 
    fr.readAsDataURL(file); 
  }); 
}

/* ---------- Create / Update User ---------- */
async function adminCreateUser(){
  const u = $('#adminNewUser').value.trim(); 
  const fName = $('#adminNewFull').value.trim();
  const p = $('#adminNewPass').value; 
  const f = $('#adminNewPhoto').files[0];

  if(!u || !p) return alert('⚠️ Username & password required');

  const photo = f ? await toDataURL(f) : '';
  const obj = { username: u, fullName: fName, password: p, photo };

  const idx = users.findIndex(x=>x.username===u);
  if(idx >= 0) {
    // update existing
    if(photo) obj.photo = photo; else obj.photo = users[idx].photo;
    users[idx] = obj;
  } else {
    users.push(obj);
  }

  // Save offline
  write(K_USERS, users);
  renderUsersAdmin();

  // Save online (Firestore)
  try {
    await setDoc(doc(db, "users", obj.username), obj);
    console.log(`✅ Firestore saved: users/${obj.username}`);
    alert(`✅ User "${obj.username}" saved to Firebase + localStorage!`);
  } catch (err) {
    console.error("❌ Firestore error (users):", err);
    alert(`⚠️ User "${obj.username}" saved offline only.\nError: ${err.message}`);
  }

  // clear form
  $('#adminNewUser').value='';
  $('#adminNewFull').value='';
  $('#adminNewPass').value='';
  $('#adminNewPhoto').value='';
}

function adminEditUser(i){
  const u = users[i];
  $('#adminNewUser').value = u.username;
  $('#adminNewFull').value = u.fullName || '';
  $('#adminNewPass').value = u.password;
  // photo left blank so admin can choose new one
}
function adminDeleteUser(i){
  if(confirm("Delete this user?")){
    users.splice(i,1);
    write(K_USERS, users);
    renderUsersAdmin();
  }
}

function renderUsersAdmin(){
  const box = $('#adminUsersList');
  box.innerHTML = '';
  users.forEach((u, i) => {
    const div = document.createElement('div');
    div.className = 'userRow';
    div.innerHTML = `
      <img src="${u.photo || ''}" class="userPhoto">
      <span><b>${u.fullName || ''}</b> (${u.username})</span>
      <button onclick="adminEditUser(${i})">Edit</button>
      <button onclick="adminDeleteUser(${i})">Delete</button>
    `;
    box.appendChild(div);
  });
}


function adminClearUsers(){ if(!confirm('Delete ALL users?')) return; users = []; write(K_USERS, users); renderUsersAdmin(); }

/* Results admin */
async function renderResults() {
  const out = $('#resultsArea'); 
  out.innerHTML = '<div class="small">Decrypting...</div>';

  // Load encrypted results from storage
  let stored = read(K_RESULTS, null);
  if (!stored) {
    out.innerHTML = '<div class="small">No results yet</div>';
    return;
  }

  try {
    // 🔓 Decrypt results before using
    const decrypted = await decryptData(stored);

    if (decrypted.length === 0) {
      out.innerHTML = '<div class="small">No results yet</div>';
      return;
    }

    const table = document.createElement('table'); 
    table.className = 'table';

    const thead = document.createElement('thead'); 
    thead.innerHTML = '<tr><th>User</th><th>Total %</th><th>Synopsis</th><th>Minor Practical</th><th>Major Practical</th><th>Viva</th><th>Time</th></tr>'; 
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    decrypted.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.username}</td>
        <td>${r.totalScorePercent}</td>
        <td>${r.sectionScores['Synopsis'] || 0}</td>
        <td>${r.sectionScores['Minor Practical'] || 0}</td>
        <td>${r.sectionScores['Major Practical'] || 0}</td>
        <td>${r.sectionScores['Viva'] || 0}</td>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody); 
    out.innerHTML = ''; 
    out.appendChild(table);

  } catch (err) {
    out.innerHTML = '<div class="small danger">⚠️ Failed to decrypt results</div>';
    console.error(err);
  }
}

function clearResults(){ if(!confirm('Clear all results?')) return; results = []; write(K_RESULTS, results); renderResults(); }
/* Exam Settings */
/* ---------- Save Exam Settings ---------- */
/* ---------- Save Exam Settings ---------- */
async function saveExamSettings() {
  const dur = parseInt($('#adminDuration').value) || 30;
  const msg = $('#adminCustomMsg').value || "📢 Welcome to your exam! Stay calm, focus, and do your best!";
  const shuffle = $('#adminShuffle').checked;
  const allowAfterTime = $('#adminAllowAfterTime').checked;

  const logoFile = document.getElementById('adminLogo').files[0];
  const logo = logoFile ? await toDataURL(logoFile) : (settings.logo || "");

  const settingsObj = {
    durationMin: dur,
    customMsg: msg,
    shuffle,
    allowAfterTime,
    logo,   // ✅ new
    author: document.getElementById('adminAuthor').value || "",
    college: document.getElementById('adminCollege').value || "",
    subject: document.getElementById('adminSubject').value || "",
    subjectCode: document.getElementById('adminSubjectCode').value || "",
    fullMarks: parseInt(document.getElementById('adminFullMarks').value) || 0,
    counts: {
      Synopsis: parseInt($('#adminCountSynopsis').value) || 0,
      "Minor Practical": parseInt($('#adminCountMinor').value) || 0,
      "Major Practical": parseInt($('#adminCountMajor').value) || 0,
      Viva: parseInt($('#adminCountViva').value) || 0
    }
  };

  // 🔹 Update global
  settings = settingsObj;

  // 🔹 Save offline
  write(K_SETTINGS, settings);

  // 🔹 Save online
  try {
    await setDoc(doc(db, "settings", "exam"), settingsObj);
await loadSettingsFromFirestore();   // ✅ reload latest from Firestore
    console.log("✅ Firestore saved: settings/exam", settingsObj);
    alert("✅ Exam settings saved to Firebase + localStorage!");
  } catch (err) {
    console.error("❌ Firestore error (settings):", err);
    alert("⚠️ Exam settings saved offline only.\nError: " + err.message);
  }

  // Always update UI
  renderSettingsAdmin();
  renderExamHeader();
}

function renderSettingsAdmin(){
  document.getElementById('adminDuration').value = settings.durationMin;
  document.getElementById('adminCustomMsg').value = settings.customMsg || "";
  document.getElementById('adminShuffle').checked = settings.shuffle || false;
document.getElementById('adminAllowAfterTime').checked = settings.allowAfterTime || false;


  // set category counts
  document.getElementById('adminCountSynopsis').value = settings.counts?.Synopsis || 0;
  document.getElementById('adminCountMinor').value = settings.counts?.["Minor Practical"] || 0;
  document.getElementById('adminCountMajor').value = settings.counts?.["Major Practical"] || 0;
  document.getElementById('adminCountViva').value = settings.counts?.Viva || 0;
updateQuestionPreview();
$('#adminAuthor').value = settings.author || "";
$('#adminCollege').value = settings.college || "";
$('#adminSubject').value = settings.subject || "";
$('#adminSubjectCode').value = settings.subjectCode || "";
$('#adminFullMarks').value = settings.fullMarks || 0;
// Logo is file input, can’t prefill directly

}

function renderExamHeader() {
  const header = document.getElementById('examHeader');
  let html = `<div>Offline MCQ Examination</div>`;

  if (settings.author) {
    html += `<div>Made by: ${escapeHTML(settings.author)}</div>`;
  }
  if (settings.college) {
    html += `<div>${escapeHTML(settings.college)}</div>`;
  }
  if (settings.subject) {
    html += `<div>Subject: ${escapeHTML(settings.subject)}</div>`;
  }
  if (settings.subjectCode) {
    html += `<div>Code: ${escapeHTML(settings.subjectCode)}</div>`;
  }
  if (settings.fullMarks) {
    html += `<div>Total Marks: ${settings.fullMarks}</div>`;
  }

  header.innerHTML = html;
}


/* Export results CSV */
function exportResultsCSV(){
  if(results.length === 0) return alert('No results to export');
  const rows = [['username','totalPercent','synopsis','minor_practical','major_practical','viva','timestamp']];
  results.forEach(r => rows.push([r.username, r.totalScorePercent, r.sectionScores['Synopsis']||0, r.sectionScores['Minor Practical']||0, r.sectionScores['Major Practical']||0, r.sectionScores['Viva']||0, new Date(r.timestamp).toISOString()]));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  download('results.csv', csv, 'text/csv');
}

/* ---------- Import / Export functions ---------- */

function triggerImportUsers(){ $('#impUsersFile').click(); }
function triggerImportQuestions(){ $('#impQFile').click(); }

function importUsersFile(e){
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> {
    try {
      const arr = JSON.parse(fr.result);
      if(!Array.isArray(arr)) throw 'bad';
      // expect objects with username,password,photo (photo optional base64)
      users = arr.map(u => ({ username: u.username, password: u.password, photo: u.photo || '' }));
      write(K_USERS, users); alert('Users imported'); renderUsersAdmin();
    } catch (err) { console.error(err); alert('Invalid users JSON'); }
  };
  fr.readAsText(f);
  e.target.value = '';
}
function importQuestionsFile(e){
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> {
    try {
      const arr = JSON.parse(fr.result);
      if(!Array.isArray(arr)) throw 'bad';
      questions = arr.map(q => ({ id: q.id || uid(), question: q.question || '', options: q.options || ['','','',''], answer: parseInt(q.answer)||0, marks: parseInt(q.marks)||1, category: q.category || 'Synopsis' }));
      write(K_QS, questions); alert('Questions imported'); renderQuestionsList();
    } catch(err){ console.error(err); alert('Invalid questions JSON'); }
  };
  fr.readAsText(f);
  e.target.value = '';
}

function exportUsers(){ download('users.json', JSON.stringify(users, null, 2), 'application/json'); }
function exportQuestions(){ download('questions.json', JSON.stringify(questions, null, 2), 'application/json'); }
function downloadBackup(){
  const backup = { users, questions, results, admin: read(K_ADMIN, null) };
  download('backup_offline_mcq.json', JSON.stringify(backup, null, 2), 'application/json');
}

function exportResultsJSON(){
  if(results.length === 0) return alert('No results to export');
  download('results.json', JSON.stringify(results, null, 2), 'application/json');
}

function triggerImportResults(){ 
  document.getElementById('impResultsFile').click(); 
}

async function importResultsFile(e) {
  const files = e.target.files;
  if (!files || files.length === 0) return;

  let allImported = [];

  for (const file of files) {
    const fr = new FileReader();
    await new Promise((resolve, reject) => {
      fr.onload = async () => {
        try {
          const imported = JSON.parse(fr.result);
          const decrypted = await decryptData(imported); // decrypt each file
          allImported = allImported.concat(decrypted);   // merge results
          resolve();
        } catch (err) {
          console.error("Failed to import file", file.name, err);
          alert(`❌ Failed to import ${file.name}`);
          reject(err);
        }
      };
      fr.readAsText(file);
    });
  }

  // 🔒 Re-encrypt merged results before saving
  const encryptedResults = await encryptData(allImported);
  write(K_RESULTS, encryptedResults);
  results = allImported;

  alert(`✅ Imported ${files.length} results file(s) successfully!`);
  renderResults();
  e.target.value = ""; // reset file input
}

function exportSettings() {
  if (!settings) return alert("No exam settings to export");
  download('exam_settings.json', JSON.stringify(settings, null, 2), 'application/json');
}

function triggerImportSettings() {
  document.getElementById('impSettingsFile').click();
}

function importSettingsFile(e) {
  const f = e.target.files[0]; if (!f) return;
  const fr = new FileReader();
  fr.onload = () => {
    try {
      const obj = JSON.parse(fr.result);
      if (!obj.durationMin || !obj.customMsg) throw 'bad';

      // ✅ restore with defaults if missing
      settings = {
        durationMin: obj.durationMin || 30,
        customMsg: obj.customMsg || "📢 Welcome to your exam! Stay calm, focus, and do your best, Made by Ranjan Kumar 🚀",
        shuffle: obj.shuffle || false,
        counts: {
          Synopsis: obj.counts?.Synopsis || 0,
          "Minor Practical": obj.counts?.["Minor Practical"] || 0,
          "Major Practical": obj.counts?.["Major Practical"] || 0,
          Viva: obj.counts?.Viva || 0
        }
      };

      write(K_SETTINGS, settings);
      alert('✅ Exam settings imported!');
      renderSettingsAdmin(); // refresh Admin panel fields
    } catch(err) {
      console.error(err);
      alert('❌ Invalid exam settings JSON');
    }
  };
  fr.readAsText(f);
  e.target.value = '';
}

/* ---------- start UI ---------- */
showSection('user');
renderQuestionsList();
renderUsersAdmin();
renderResults();

// auto-load users/questions from localStorage on page load
window.addEventListener('DOMContentLoaded', () => {
  users = read(K_USERS, []);
  questions = read(K_QS, []);
  results = read(K_RESULTS, []);
  renderQuestionsList();
  renderUsersAdmin();
  renderResults();
});

/* Expose a few for console/debug if needed */
window._data = { users, questions, results };

const character = document.getElementById("examCharacterName");
character.textContent = user.fullName;

// Smooth tracking variables
let mouseX = 0, mouseY = 0;
let charX = 0, charY = 0;
const speed = 0.15; // lower = slower lag, higher = faster

// Update mouse position
document.addEventListener('mousemove', e => {
    mouseX = e.clientX + 15; // offset
    mouseY = e.clientY + 15;
});

// Animation loop
function animate() {
    // Move character towards mouse with easing
    charX += (mouseX - charX) * speed;
    charY += (mouseY - charY) * speed;
    character.style.left = charX + 'px';
    character.style.top = charY + 'px';
    requestAnimationFrame(animate);
}

// Start animation
animate();
const ADMIN_UNLOCK_PASS = "exam123"; // 🔑 change this password
let examPaused = false;

// force fullscreen
function enterFullscreen(el) {
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}

// detect exit fullscreen
document.addEventListener("fullscreenchange", () => {
  if (!document.fullscreenElement && !EXAM.state?.submitted) {
    pauseExam();
  }
});

function pauseExam() {
  examPaused = true;
  clearInterval(EXAM.timerId); // stop timer
  document.getElementById("lockScreen").style.display = "flex";
}

// 🔹 Unlock Exam with Password
function unlockExam() {
  const input = document.getElementById("unlockPassword");
  const pass = input.value.trim();

  if (pass === ADMIN_UNLOCK_PASS) {   // ✅ FIXED HERE
    document.getElementById("lockScreen").style.display = "none";
    enterFullscreen(document.documentElement); // force fullscreen again
    startTimer(); // resume timer
    examPaused = false;
  } else {
    alert("❌ Wrong password. Try again.");
  }

  // Always clear password after attempt
  input.value = "";
}

function dismissInstructions(){
  document.getElementById("examInstructionsOverlay").style.display = "none";
}

function showInstructions(){
  document.getElementById("examInstructionsOverlay").style.display = "flex";
}
// ------------------------------
// 👇 Attractive Mouse Trail Effect
// ------------------------------
const trailContainer = document.createElement("div");
trailContainer.style.position = "fixed";
trailContainer.style.top = "0";
trailContainer.style.left = "0";
trailContainer.style.width = "100%";
trailContainer.style.height = "100%";
trailContainer.style.pointerEvents = "none";
trailContainer.style.overflow = "hidden";
trailContainer.style.zIndex = "9999";
document.body.appendChild(trailContainer);

document.addEventListener("mousemove", e => {
  const dot = document.createElement("div");
  dot.style.position = "absolute";
  dot.style.width = "12px";
  dot.style.height = "12px";
  dot.style.borderRadius = "50%";
  dot.style.background = `hsl(${Math.random()*360}, 90%, 60%)`; // rainbow colors
  dot.style.left = e.clientX + "px";
  dot.style.top  = e.clientY + "px";
  dot.style.opacity = "1";
  dot.style.transform = "scale(1)";
  dot.style.transition = "opacity 0.8s linear, transform 0.8s ease";

  trailContainer.appendChild(dot);

  // fade & shrink out
  setTimeout(() => {
    dot.style.opacity = "0";
    dot.style.transform = "scale(0.3)";
    setTimeout(() => dot.remove(), 800);
  }, 20);
});

function updateStats() {
  if (!EXAM.state) return;

  const answered = Object.keys(EXAM.state.answers).length;
  const notAnswered = EXAM.paper.length - answered;
  const flagged = Object.keys(EXAM.state.flags).length;

  document.getElementById("answerStats").innerHTML = `
    <span style="color: var(--good)">Answered: ${answered}</span> |
    <span style="color: var(--danger)">Not Answered: ${notAnswered}</span> |
    <span style="color: orange">Flagged: ${flagged}</span>
  `;
}
function updateQuestionPreview(){
  const s = parseInt(document.getElementById('adminCountSynopsis').value) || 0;
  const m = parseInt(document.getElementById('adminCountMinor').value) || 0;
  const maj = parseInt(document.getElementById('adminCountMajor').value) || 0;
  const v = parseInt(document.getElementById('adminCountViva').value) || 0;

  const total = s + m + maj + v;

  document.getElementById('questionPreview').innerText = 
    "Total Questions: " + total;
}
// Auto-import JSON files on startup
async function autoImportJSON() {
  let imported = false;
  try {
    // Try full backup first
    const res = await fetch("exam_full_backup.json");
    if (res.ok) {
      const backup = await res.json();
      users = backup.users || [];
      questions = backup.questions || [];
      results = backup.results || [];
      settings = backup.settings || settings;
      adminCred = backup.adminCred || MASTER_ADMIN;

      write(K_USERS, users);
      write(K_QS, questions);
      write(K_RESULTS, results);
      write(K_SETTINGS, settings);
      write(K_ADMIN, adminCred);

      showImportMessage("✅ Auto-imported exam_full_backup.json successfully!");
      imported = true;
      return;
    }
  } catch {}

  // Try users.json
  try {
    const resUsers = await fetch("users.json");
    if (resUsers.ok) {
      users = await resUsers.json();
      write(K_USERS, users);
      showImportMessage("✅ Auto-imported users.json successfully!");
      imported = true;
    }
  } catch {}

  // Try questions.json
  try {
    const resQs = await fetch("questions.json");
    if (resQs.ok) {
      questions = await resQs.json();
      write(K_QS, questions);
      showImportMessage("✅ Auto-imported questions.json successfully!");
      imported = true;
    }
  } catch {}

  if (!imported) {
    showImportMessage("⚠️ No JSON file found for auto-import.");
  }
}

// 🔹 Helper to display banner message
function showImportMessage(msg) {
  let banner = document.getElementById("examMsg");

  if (!banner) {
    // create banner if it doesn't exist
    banner = document.createElement("div");
    banner.id = "examMsg";
    banner.style.cssText = `
      width: 100%;
      padding: 8px;
      text-align: center;
      font-weight: bold;
      background: #222;
      color: #34d399;
    `;
    document.body.prepend(banner);
  }

  banner.textContent = msg;
  banner.style.display = "block";   // ensure it's visible
}

// Run on startup
window.addEventListener("DOMContentLoaded", () => {
  initApp();
})

async function loadSettingsFromFirestore() {
  try {
    const snap = await getDoc(doc(db, "settings", "exam"));
    if (snap.exists()) {
      settings = snap.data();
      write(K_SETTINGS, settings); // sync offline copy
      console.log("✅ Loaded settings from Firestore:", settings);
    } else {
      console.warn("⚠️ No settings found in Firestore, using offline copy");
      settings = read(K_SETTINGS, {});
    }
  } catch (err) {
    console.error("❌ Firestore load error (settings):", err);
    settings = read(K_SETTINGS, {});
  }
}
async function loadQuestionsFromFirestore() {
  try {
    const qs = [];
    const snap = await getDocs(collection(db, "questions"));
    snap.forEach(docSnap => qs.push(docSnap.data()));
    if (qs.length > 0) {
      questions = qs;
      write(K_QS, questions);
      console.log("✅ Loaded questions from Firestore:", questions);
    }
  } catch (err) {
    console.error("❌ Firestore load error (questions):", err);
    questions = read(K_QS, []);
  }
}
  async function loadUsersFromFirestore() {
  try {
    const arr = [];
    const snap = await getDocs(collection(db, "users"));
    snap.forEach(docSnap => arr.push(docSnap.data()));
    if (arr.length > 0) {
      users = arr;
      write(K_USERS, users);
      console.log("✅ Loaded users from Firestore:", users);
    }
  } catch (err) {
    console.error("❌ Firestore load error (users):", err);
    users = read(K_USERS, []);
  }
}

async function loadResultsFromFirestore() {
  try {
    const arr = [];
    const snap = await getDocs(collection(db, "results"));
    snap.forEach(docSnap => arr.push(docSnap.data()));
    if (arr.length > 0) {
      results = arr;
      write(K_RESULTS, results);
      console.log("✅ Loaded results from Firestore:", results);
    }
  } catch (err) {
    console.error("❌ Firestore load error (results):", err);
    results = read(K_RESULTS, []);
  }
}

async function initApp() {
  await loadSettingsFromFirestore();
  await loadQuestionsFromFirestore();
  await loadUsersFromFirestore();
  await loadResultsFromFirestore();

  renderSettingsAdmin();
  renderExamHeader();
  renderQuestionsList();
  renderUsersAdmin();
  renderResults();
}


</script>
</body>
</html>


